<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NÃ´ng Tráº¡i Heo Con - Cá»­a HÃ ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Lexend', sans-serif; background: #f8fafc; }
        .bg-header { position: absolute; top: 0; left: 0; width: 100%; height: 200px; background: linear-gradient(135deg, #065f46, #064e3b); border-radius: 0 0 50px 50px; z-index: 0; }
        .glass-panel { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.8); }
        .scroll-area { position: absolute; top: 210px; bottom: 85px; left: 0; width: 100%; overflow-y: auto; padding: 0 16px; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-between; align-items: center; z-index: 150; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); border-radius: 24px 24px 0 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #9ca3af; padding-top: 5px; }
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn { position: absolute; top: -30px; width: 65px; height: 65px; background: linear-gradient(135deg, #10b981, #047857); border: 5px solid #fdfdfd; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tab-btn { transition: all 0.3s; border-radius: 15px; font-weight: 800; font-size: 13px; }
        .tab-active { background: white; color: #065f46; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #post-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        #post-modal.active { display: flex; }
    </style>
</head>
<body>
    <div class="bg-header"></div>
    <div class="absolute top-5 left-0 w-full px-6 flex justify-between items-center z-50 text-white">
        <h1 class="text-2xl font-black">Cá»­a HÃ ng</h1>
        <div class="glass-panel px-4 py-2 rounded-2xl text-emerald-800 font-black"><span id="gold-val">0</span> ğŸ’°</div>
    </div>
    <div class="absolute top-[100px] left-0 w-full px-5 z-20">
        <div class="bg-black/20 p-1.5 rounded-[1.5rem] flex gap-1 border border-white/10"><button id="tabQuick" class="tab-btn flex-1 py-3 tab-active">BÃN NHANH</button><button id="tabMarket" class="tab-btn flex-1 py-3 text-white/70">CHá»¢ Cá»˜NG Äá»’NG</button></div>
        <button id="btnOpenPost" class="hidden w-full mt-3 bg-orange-500 text-white py-3.5 rounded-2xl font-black shadow-lg">ğŸ“¦ ÄÄ‚NG BÃN NÃ”NG PHáº¨M</button>
    </div>
    <div class="scroll-area no-scrollbar" id="content"></div>

    <!-- Modal Post -->
    <div id="post-modal">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl">
            <h2 class="text-xl font-black mb-5">Rao bÃ¡n lÃªn Chá»£</h2>
            <select id="p-id" class="w-full bg-stone-100 p-4 rounded-2xl mb-4 font-bold outline-none"></select>
            <div class="flex gap-3 mb-4">
                <input type="number" id="p-qty" value="1" class="flex-1 bg-stone-100 p-4 rounded-2xl font-black" placeholder="SL">
                <input type="number" id="p-price" class="flex-1 bg-stone-100 p-4 rounded-2xl font-black" placeholder="GiÃ¡/1Ä‘v">
            </div>
            <div class="flex gap-2"><button onclick="document.getElementById('post-modal').classList.remove('active')" class="flex-1 py-4 bg-stone-100 font-black rounded-2xl uppercase text-xs">Há»§y</button><button id="p-confirm" class="flex-[2] py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg uppercase text-xs">ÄÄƒng bÃ¡n</button></div>
        </div>
    </div>

    <div class="nav-bar">
        <a href="shop.html" class="nav-item text-emerald-600"><span class="text-2xl mb-1">ğŸ›ï¸</span><span class="text-[9px] font-black uppercase tracking-wide">Cá»­a hÃ ng</span></a>
        <a href="kho.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ“¦</span><span class="text-[9px] font-black uppercase tracking-wide">Kho</span></a>
        <a href="trangchu.html" class="nav-center-wrap"><div class="nav-center-btn"><span class="text-3xl opacity-80">ğŸŒ±</span></div><span class="text-[10px] mt-12 font-black text-stone-400">Äáº§u tÆ°</span></a>
        <a href="gt.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ®</span><span class="text-[9px] font-black uppercase tracking-wide">Giáº£i trÃ­</span></a>
        <a href="tk.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ‘¤</span><span class="text-[9px] font-black uppercase tracking-wide">TÃ i khoáº£n</span></a>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, addDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0", authDomain: "nongtraiheocon.firebaseapp.com", projectId: "nongtraiheocon", storageBucket: "nongtraiheocon.firebasestorage.app", messagingSenderId: "964519162656", appId: "1:964519162656:web:27247ed6287dfc74ef5d45" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "nongtraiheocon";

    const INFO = { carrot: { n: 'CÃ  rá»‘t', i: 'ğŸ¥•', q: 350, b: 'bg-orange-100' }, cow: { n: 'Sá»¯a tÆ°Æ¡i', i: 'ğŸ¥›', q: 2800, b: 'bg-sky-100' }, chicken: { n: 'Trá»©ng gÃ ', i: 'ğŸ¥š', q: 1800, b: 'bg-yellow-100' }, sheep: { n: 'BÃ´ng váº£i', i: 'â˜ï¸', q: 9500, b: 'bg-slate-100' } };
    let uState = { gold: 0, inventory: {} };
    let curTab = 'quick';
    let unsub = null;

    onAuthStateChanged(auth, async (u) => {
        if(u) { await load(); switchTab('quick'); } else window.location.href = 'index.html';
    });

    async function load() {
        // TuÃ¢n thá»§ Rule 1: /artifacts/{appId}/users/{userId}/data/global
        const snap = await getDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'data', 'global'));
        if(snap.exists()) { uState = snap.data(); document.getElementById('gold-val').innerText = (uState.gold || 0).toLocaleString(); }
    }

    async function sync() {
        const userDocRef = doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'data', 'global');
        await setDoc(userDocRef, uState, { merge: true });
    }

    window.switchTab = (t) => {
        curTab = t;
        document.getElementById('tabQuick').className = t==='quick' ? "tab-btn flex-1 py-3 tab-active" : "tab-btn flex-1 py-3 text-white/70";
        document.getElementById('tabMarket').className = t==='market' ? "tab-btn flex-1 py-3 tab-active" : "tab-btn flex-1 py-3 text-white/70";
        document.getElementById('btnOpenPost').classList.toggle('hidden', t==='quick');
        if(t==='quick') renderQuick(); else listenMarket();
    };
    document.getElementById('tabQuick').onclick = () => switchTab('quick');
    document.getElementById('tabMarket').onclick = () => switchTab('market');

    function renderQuick() {
        const c = document.getElementById('content'); c.innerHTML = '';
        const its = Object.entries(uState.inventory || {}).filter(([id, q]) => q > 0 && INFO[id]);
        if(its.length===0) c.innerHTML = `<p class="text-center py-20 opacity-30 font-black text-xs">KHÃ”NG CÃ“ HÃ€NG Äá»‚ BÃN NHANH</p>`;
        its.forEach(([id, q]) => {
            const it = INFO[id];
            c.innerHTML += `<div class="glass-panel p-4 rounded-[2rem] flex items-center gap-4 mb-4">
                <div class="w-16 h-16 ${it.b} rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white">${it.i}</div>
                <div class="flex-1 min-w-0"><h3 class="font-black text-sm text-stone-800">${it.n}</h3><p class="text-xs font-bold text-emerald-600">ThÆ°Æ¡ng lÃ¡i mua: ${it.q} ğŸ’°</p><p class="text-[10px] font-bold text-stone-400">Kho: ${q}</p></div>
                <button onclick="window.doSell('${id}')" class="bg-emerald-600 text-white font-black text-xs py-2.5 px-5 rounded-xl shadow-md active:scale-95 transition-all">BÃN</button>
            </div>`;
        });
    }

    window.doSell = async (id) => {
        if(uState.inventory[id] > 0) {
            uState.inventory[id]--; uState.gold += INFO[id].q;
            document.getElementById('gold-val').innerText = uState.gold.toLocaleString();
            renderQuick(); await sync();
        }
    };

    function listenMarket() {
        if(unsub) unsub();
        // TuÃ¢n thá»§ Rule 1: /artifacts/{appId}/public/data/market
        unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'market'), s => {
            const c = document.getElementById('content'); c.innerHTML = '';
            const docs = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
            if(docs.length===0) c.innerHTML = `<p class="text-center py-20 opacity-30 font-black text-xs uppercase tracking-widest">Chá»£ chÆ°a cÃ³ hÃ ng</p>`;
            docs.forEach(it => {
                const mine = it.sellerId === auth.currentUser.uid;
                const meta = INFO[it.itemType];
                c.innerHTML += `<div class="glass-panel p-4 rounded-[2rem] flex items-center gap-4 mb-4 ${mine?'border-orange-200 bg-orange-50/10':''}">
                    <div class="w-14 h-14 ${meta.b} rounded-2xl flex items-center justify-center text-3xl shadow-inner">${meta.i}</div>
                    <div class="flex-1 min-w-0"><h3 class="font-black text-sm">${it.quantity} ${meta.n}</h3><p class="text-xs font-bold text-orange-600">Tá»•ng: ${it.totalPrice} ğŸ’°</p><p class="text-[9px] text-stone-400 font-bold uppercase truncate">${mine?'Báº¡n Ä‘Äƒng':it.sellerName}</p></div>
                    ${mine?`<button onclick="window.cancel('${it.id}','${it.itemType}',${it.quantity})" class="text-[10px] font-black text-stone-300">Há»¦Y</button>`:`<button onclick="window.buy('${it.id}')" class="bg-orange-500 text-white font-black text-xs py-2.5 px-4 rounded-xl shadow-lg active:scale-95">MUA</button>`}
                </div>`;
            });
        });
    }

    document.getElementById('btnOpenPost').onclick = () => {
        const s = document.getElementById('p-id'); s.innerHTML = '';
        Object.entries(uState.inventory).forEach(([id, q]) => { if(q>0) s.innerHTML += `<option value="${id}">${INFO[id].n} (Sáºµn cÃ³: ${q})</option>`; });
        if(s.options.length > 0) document.getElementById('post-modal').classList.add('active');
    };

    document.getElementById('p-confirm').onclick = async () => {
        const id = document.getElementById('p-id').value; const q = parseInt(document.getElementById('p-qty').value); const p = parseInt(document.getElementById('p-price').value);
        if(q > 0 && p > 0 && uState.inventory[id] >= q) {
            uState.inventory[id] -= q; await sync();
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'market'), { sellerId: auth.currentUser.uid, sellerName: auth.currentUser.displayName || "NÃ´ng DÃ¢n", itemType: id, quantity: q, totalPrice: q*p, timestamp: serverTimestamp() });
            document.getElementById('post-modal').classList.remove('active');
        }
    };

    window.buy = async (did) => {
        const r = doc(db, 'artifacts', appId, 'public', 'data', 'market', did); const s = await getDoc(r);
        if(s.exists()) {
            const it = s.data();
            if(uState.gold >= it.totalPrice) {
                uState.gold -= it.totalPrice; uState.inventory[it.itemType] = (uState.inventory[it.itemType]||0) + it.quantity;
                await sync();
                const sellerGlobalRef = doc(db, 'artifacts', appId, 'users', it.sellerId, 'data', 'global');
                await updateDoc(sellerGlobalRef, { gold: increment(it.totalPrice) });
                await deleteDoc(r);
                alert("ÄÃ£ mua thÃ nh cÃ´ng!");
            } else alert("Báº¡n khÃ´ng Ä‘á»§ VÃ ng!");
        }
    };

    window.cancel = async (did, type, q) => {
        if(confirm("Há»§y tin vÃ  nháº­n láº¡i hÃ ng?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'market', did));
            uState.inventory[type] = (uState.inventory[type]||0) + q; await sync();
        }
    };
</script>
</body>
</html>

