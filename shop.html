<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√¥ng Tr·∫°i Heo Con - C·ª≠a H√†ng & Ch·ª£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Lexend', sans-serif;
            background: #f8fafc; 
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }

        .bg-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 200px;
            background: linear-gradient(135deg, #065f46, #064e3b);
            border-radius: 0 0 50px 50px; z-index: 0;
            box-shadow: 0 10px 30px rgba(6, 78, 59, 0.2);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
        }

        .scroll-area {
            position: absolute; top: 210px; bottom: 85px; left: 0; width: 100%;
            overflow-y: auto; padding: 0 16px; z-index: 10;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between;
            align-items: center; z-index: 150;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            border-radius: 24px 24px 0 0;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: #9ca3af; transition: all 0.2s; padding-top: 5px;
        }
        
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn {
            position: absolute; top: -30px; width: 65px; height: 65px;
            background: linear-gradient(135deg, #10b981, #047857);
            border: 5px solid #f8fafc; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.2);
        }

        .tab-btn { transition: all 0.3s; border-radius: 15px; font-weight: 800; font-size: 13px; }
        .tab-active { background: white; color: #065f46; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        #post-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(4px);
        }
        #post-modal.active { display: flex; }

        .float-info { 
            position: absolute; pointer-events: none; font-weight: 900; 
            font-size: 20px; text-shadow: 1px 1px 0 #fff;
            animation: floatUp 1s ease-out forwards; z-index: 200; 
        }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 20% { opacity: 1; transform: translateY(-20px); } 100% { opacity: 0; transform: translateY(-80px); } }

        #loading-screen {
            position: fixed; inset: 0; background: #064e3b; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="text-6xl animate-bounce mb-3">üè™</div>
    <h2 class="text-xl font-black mb-1 tracking-widest text-emerald-300">ƒêANG K·∫æT N·ªêI...</h2>
</div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-300">
    <div class="bg-header"></div>
    
    <!-- Header -->
    <div class="absolute top-5 left-0 w-full px-6 flex justify-between items-center z-50">
        <div>
            <h1 class="text-white text-2xl font-black tracking-tight">C·ª≠a H√†ng</h1>
            <p class="text-emerald-200 text-[10px] font-bold uppercase tracking-widest">Giao d·ªãch th·ªùi gian th·ª±c</p>
        </div>
        <div class="glass-panel px-4 py-2 rounded-2xl flex items-center gap-2 border-emerald-100/50">
            <span class="text-xl">üí∞</span>
            <span id="gold-val" class="font-black text-orange-600 text-lg">---</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="absolute top-[100px] left-0 w-full px-5 z-20">
        <div class="bg-black/20 backdrop-blur-md p-1.5 rounded-[1.5rem] flex gap-1 border border-white/10">
            <button id="tab-quick" class="tab-btn flex-1 py-3 tab-active">B√ÅN NHANH</button>
            <button id="tab-market" class="tab-btn flex-1 py-3 text-white/70">CH·ª¢ N√îNG D√ÇN</button>
        </div>
        
        <button id="btn-open-post" class="hidden w-full mt-3 bg-orange-500 text-white py-3.5 rounded-2xl font-black shadow-lg shadow-orange-200 active:scale-95 transition-all">
            üì¶ ƒêƒÇNG B√ÅN N√îNG PH·∫®M
        </button>
    </div>

    <!-- Content List -->
    <div class="scroll-area no-scrollbar" id="content-list"></div>

    <!-- Modal Post -->
    <div id="post-modal">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-orange-500"></div>
            <h2 class="text-xl font-black text-stone-800 mb-5">Rao b√°n l√™n Ch·ª£</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-black text-stone-400 uppercase mb-1.5 ml-1 tracking-wider">S·∫£n ph·∫©m c√≥ s·∫µn</label>
                    <select id="post-item-id" class="w-full bg-stone-100 p-4 rounded-2xl border-none font-bold text-stone-700 outline-none ring-offset-2 focus:ring-2 focus:ring-orange-500 transition-all"></select>
                </div>
                
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="block text-[10px] font-black text-stone-400 uppercase mb-1.5 ml-1 tracking-wider">S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="post-item-qty" value="1" min="1" class="w-full bg-stone-100 p-4 rounded-2xl font-black text-stone-700 outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                    <div class="flex-1">
                        <label class="block text-[10px] font-black text-stone-400 uppercase mb-1.5 ml-1 tracking-wider">Gi√° / 1 ƒëv</label>
                        <input type="number" id="post-item-price" placeholder="üí∞" class="w-full bg-stone-100 p-4 rounded-2xl font-black text-stone-700 outline-none focus:ring-2 focus:ring-orange-500">
                    </div>
                </div>
                
                <div class="bg-orange-50 p-3 rounded-xl">
                    <p class="text-[10px] text-orange-600 font-bold leading-tight">M·∫πo: ƒêƒÉng b√°n gi√° cao h∆°n "B√°n nhanh" m·ªôt ch√∫t ƒë·ªÉ t·ªëi ∆∞u l·ª£i nhu·∫≠n!</p>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="document.getElementById('post-modal').classList.remove('active')" class="flex-1 py-4 bg-stone-100 text-stone-500 font-black rounded-2xl">H·ª¶Y</button>
                    <button id="confirm-post-btn" class="flex-[2] py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg shadow-emerald-100 active:scale-95 transition-transform">ƒêƒÇNG B√ÅN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-bar">
        <a href="shop.html" class="nav-item text-emerald-600"><span class="text-2xl mb-1">üõçÔ∏è</span><span class="text-[9px] font-black uppercase tracking-wide">C·ª≠a h√†ng</span></a>
        <a href="kho.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üì¶</span><span class="text-[9px] font-black uppercase tracking-wide">Kho</span></a>
        <a href="trangchu.html" class="nav-center-wrap"><div class="nav-center-btn"><span class="text-3xl pb-1 opacity-80">üå±</span></div><span class="text-[10px] font-black uppercase mt-12 tracking-wider text-stone-400">ƒê·∫ßu t∆∞</span></a>
        <a href="gt.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üéÆ</span><span class="text-[9px] font-black uppercase tracking-wide">Gi·∫£i tr√≠</span></a>
        <a href="tk.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üë§</span><span class="text-[9px] font-black uppercase tracking-wide">T√†i kho·∫£n</span></a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, addDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45",
      measurementId: "G-RT8HPTJERF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "nongtraiheocon";

    const ITEMS_DATA = {
        carrot: { name: 'C√† r·ªët', icon: 'ü•ï', quickPrice: 350, bg: 'bg-orange-100' },
        cow: { name: 'S·ªØa t∆∞∆°i', icon: 'ü•õ', quickPrice: 2800, bg: 'bg-sky-100' },
        chicken: { name: 'Tr·ª©ng g√†', icon: 'ü•ö', quickPrice: 1800, bg: 'bg-yellow-100' },
        sheep: { name: 'B√¥ng v·∫£i', icon: '‚òÅÔ∏è', quickPrice: 9500, bg: 'bg-slate-100' }
    };

    let userState = { gold: 0, inventory: {}, displayName: "" };
    let currentUser = null;
    let currentTab = 'quick';
    let marketUnsubscribe = null;

    // Kh·ªüi t·∫°o
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await refreshUserData();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-container').style.opacity = '1';
            switchTab('quick');
        } else {
            window.location.href = 'index.html';
        }
    });

    async function refreshUserData() {
        const snap = await getDoc(doc(db, "users", currentUser.uid));
        if (snap.exists()) {
            userState = { ...userState, ...snap.data() };
            document.getElementById('gold-val').innerText = userState.gold.toLocaleString();
        }
    }

    async function syncCloud() {
        if (!currentUser) return;
        await setDoc(doc(db, "users", currentUser.uid), {
            gold: userState.gold,
            inventory: userState.inventory
        }, { merge: true });
    }

    // --- Tab Logic ---
    window.switchTab = (tab) => {
        currentTab = tab;
        const quickBtn = document.getElementById('tab-quick');
        const marketBtn = document.getElementById('tab-market');
        const postBtn = document.getElementById('btn-open-post');
        
        if (tab === 'quick') {
            quickBtn.className = "tab-btn flex-1 py-3 tab-active";
            marketBtn.className = "tab-btn flex-1 py-3 text-white/70";
            postBtn.classList.add('hidden');
            renderQuickSell();
            if (marketUnsubscribe) marketUnsubscribe();
        } else {
            marketBtn.className = "tab-btn flex-1 py-3 tab-active";
            quickBtn.className = "tab-btn flex-1 py-3 text-white/70";
            postBtn.classList.remove('hidden');
            renderMarketplace();
        }
    };

    document.getElementById('tab-quick').onclick = () => switchTab('quick');
    document.getElementById('tab-market').onclick = () => switchTab('market');

    // --- B√°n Nhanh (Merchant) ---
    function renderQuickSell() {
        const container = document.getElementById('content-list');
        container.innerHTML = '';
        const items = Object.entries(userState.inventory).filter(([id, qty]) => qty > 0 && ITEMS_DATA[id]);

        if (items.length === 0) {
            container.innerHTML = `<div class="flex flex-col items-center justify-center py-20 opacity-30 text-center"><span class="text-7xl mb-4">üè™</span><p class="font-black text-stone-600 text-sm">KHO ƒêANG TR·ªêNG</p></div>`;
            return;
        }

        items.forEach(([id, qty]) => {
            const info = ITEMS_DATA[id];
            const card = document.createElement('div');
            card.className = "glass-panel p-4 rounded-[2rem] flex items-center gap-4 mb-4";
            card.innerHTML = `
                <div class="w-16 h-16 ${info.bg} rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white/50">${info.icon}</div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-black text-stone-800 text-sm leading-tight truncate">${info.name}</h3>
                    <p class="text-xs font-bold text-emerald-600 mt-0.5">Gi√°: ${info.quickPrice} üí∞</p>
                    <p class="text-[10px] text-stone-400 font-bold uppercase mt-1">Trong kho: ${qty}</p>
                </div>
                <button onclick="window.doQuickSell('${id}', event)" class="bg-emerald-600 text-white font-black text-xs py-2.5 px-5 rounded-xl shadow-md active:scale-90 transition-all">B√ÅN</button>
            `;
            container.appendChild(card);
        });
    }

    window.doQuickSell = async (id, e) => {
        if (userState.inventory[id] > 0) {
            const earn = ITEMS_DATA[id].quickPrice;
            userState.inventory[id] -= 1;
            userState.gold += earn;
            
            document.getElementById('gold-val').innerText = userState.gold.toLocaleString();
            renderQuickSell();
            showFloat(e.target.getBoundingClientRect().left, e.target.getBoundingClientRect().top, `+${earn} üí∞`, "#f59e0b");
            await syncCloud();
        }
    };

    // --- Ch·ª£ C·ªông ƒê·ªìng (Marketplace) ---
    function renderMarketplace() {
        const container = document.getElementById('content-list');
        const q = collection(db, 'artifacts', appId, 'public', 'data', 'market');
        
        marketUnsubscribe = onSnapshot(q, (snapshot) => {
            container.innerHTML = '';
            const docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));

            if (docs.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center py-20 opacity-30 text-center"><span class="text-7xl mb-4">üõí</span><p class="font-black text-stone-600 text-sm">CH·ª¢ CH∆ØA C√ì H√ÄNG</p></div>`;
                return;
            }

            docs.forEach(item => {
                const info = ITEMS_DATA[item.itemType];
                if(!info) return;
                const isMine = item.sellerId === currentUser.uid;
                const card = document.createElement('div');
                card.className = `glass-panel p-4 rounded-[2rem] flex items-center gap-4 mb-4 ${isMine ? 'border-orange-200 bg-orange-50/20' : ''}`;
                card.innerHTML = `
                    <div class="w-16 h-16 ${info.bg} rounded-2xl flex items-center justify-center text-3xl shrink-0">${info.icon}</div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-black text-stone-800 text-sm truncate">${item.quantity} ${info.name}</h3>
                        <p class="text-xs font-bold text-orange-600">T·ªïng: ${item.totalPrice.toLocaleString()} üí∞</p>
                        <p class="text-[9px] text-stone-400 font-bold uppercase truncate mt-1">B√°n b·ªüi: ${isMine ? 'B·∫°n' : item.sellerName}</p>
                    </div>
                    ${isMine ? 
                        `<button onclick="window.cancelMarketPost('${item.id}', '${item.itemType}', ${item.quantity})" class="bg-stone-100 text-stone-400 font-black text-[10px] py-2 px-3 rounded-xl">H·ª¶Y</button>` :
                        `<button onclick="window.buyFromMarket('${item.id}', event)" class="bg-orange-500 text-white font-black text-xs py-2.5 px-5 rounded-xl shadow-md active:scale-90 transition-all">MUA</button>`
                    }
                `;
                container.appendChild(card);
            });
        });
    }

    // ƒêƒÉng b√°n
    document.getElementById('btn-open-post').onclick = () => {
        const select = document.getElementById('post-item-id');
        select.innerHTML = '';
        Object.entries(userState.inventory).forEach(([id, qty]) => {
            if (qty > 0 && ITEMS_DATA[id]) {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${ITEMS_DATA[id].name} (S·∫µn c√≥: ${qty})`;
                select.appendChild(opt);
            }
        });

        if (select.options.length === 0) {
            alert("B·∫°n kh√¥ng c√≥ n√¥ng s·∫£n ƒë·ªÉ rao b√°n!");
            return;
        }
        document.getElementById('post-modal').classList.add('active');
    };

    document.getElementById('confirm-post-btn').onclick = async () => {
        const itemId = document.getElementById('post-item-id').value;
        const qty = parseInt(document.getElementById('post-item-qty').value);
        const price = parseInt(document.getElementById('post-item-price').value);

        if (!qty || qty <= 0 || !price || price <= 0) return alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng v√† gi√°!");
        if (userState.inventory[itemId] < qty) return alert("Kh√¥ng ƒë·ªß h√†ng trong kho!");

        // Tr·ª´ kho ngay l·∫≠p t·ª©c
        userState.inventory[itemId] -= qty;
        await syncCloud();

        // ƒê·∫©y l√™n ch·ª£ c√¥ng khai
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'market'), {
            sellerId: currentUser.uid,
            sellerName: userState.displayName || "N√¥ng D√¢n",
            itemType: itemId,
            quantity: qty,
            pricePerUnit: price,
            totalPrice: qty * price,
            timestamp: serverTimestamp()
        });

        document.getElementById('post-modal').classList.remove('active');
    };

    window.buyFromMarket = async (docId, e) => {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'market', docId);
        const snap = await getDoc(docRef);
        
        if (!snap.exists()) return alert("H√†ng ƒë√£ b·ªã ng∆∞·ªùi kh√°c mua ho·∫∑c g·ª° b·ªè!");
        
        const item = snap.data();
        if (userState.gold < item.totalPrice) return alert("B·∫°n kh√¥ng ƒë·ªß V√†ng!");

        // 1. Tr·ª´ ti·ªÅn ng∆∞·ªùi mua, c·ªông v·∫≠t ph·∫©m
        userState.gold -= item.totalPrice;
        userState.inventory[item.itemType] = (userState.inventory[item.itemType] || 0) + item.quantity;
        await syncCloud();

        // 2. C·ªông ti·ªÅn cho ng∆∞·ªùi b√°n
        await updateDoc(doc(db, 'users', item.sellerId), {
            gold: increment(item.totalPrice)
        });

        // 3. X√≥a b√†i ƒëƒÉng
        await deleteDoc(docRef);
        
        document.getElementById('gold-val').innerText = userState.gold.toLocaleString();
        showFloat(e.target.getBoundingClientRect().left, e.target.getBoundingClientRect().top, `-${item.totalPrice} üí∞`, "red");
        alert("Mua h√†ng th√†nh c√¥ng!");
    };

    window.cancelMarketPost = async (docId, type, qty) => {
        if(confirm("H·ªßy ƒëƒÉng b√°n v√† nh·∫≠n l·∫°i h√†ng?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'market', docId));
            userState.inventory[type] = (userState.inventory[type] || 0) + qty;
            await syncCloud();
        }
    };

    function showFloat(x, y, txt, color) {
        const div = document.createElement('div');
        div.className = 'float-info'; div.innerText = txt;
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.color = color;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    }
</script>
</body>
</html>

