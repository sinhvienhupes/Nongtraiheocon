<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NÃ´ng Tráº¡i Heo Con - Trang Chá»§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        body { margin: 0; padding: 0; overflow: hidden; font-family: 'Lexend', sans-serif; background: #f0f2f5; user-select: none; }
        .bg-header { position: absolute; top: 0; left: 0; width: 100%; height: 240px; background: linear-gradient(135deg, #0f766e, #064e3b); border-radius: 0 0 45px 45px; z-index: 0; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05); }
        .scroll-area { position: absolute; top: 195px; bottom: 85px; left: 0; width: 100%; overflow-y: auto; padding: 0 16px; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .progress-bg { width: 100%; background: #e5e7eb; border-radius: 999px; height: 12px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 1s linear; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-between; align-items: center; z-index: 150; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); border-radius: 24px 24px 0 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #9ca3af; padding-top: 5px; }
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn { position: absolute; top: -30px; width: 65px; height: 65px; background: linear-gradient(135deg, #10b981, #047857); border: 5px solid #f0f2f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
        #loading-screen { position: fixed; inset: 0; background: #064e3b; z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; transition: opacity 0.2s; }
        .float-info { position: absolute; pointer-events: none; font-weight: 900; font-size: 18px; text-shadow: 1px 1px 0 #fff; animation: floatUp 1s forwards; z-index: 200; }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-70px); } }
    </style>
</head>
<body>

<div id="loading-screen"><h2 class="text-xl font-black animate-pulse tracking-widest text-emerald-300">ÄANG Äá»’NG Bá»˜...</h2></div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-300">
    <div class="bg-header"></div>
    <div class="absolute top-5 left-0 w-full px-5 flex justify-between items-start z-50">
        <div>
            <h1 id="player-name" class="text-white text-base font-black leading-tight">...</h1>
            <p class="text-emerald-200 text-[10px] font-bold uppercase tracking-wide">Cáº¥p Ä‘á»™ <span id="lvl-val">1</span></p>
            <a href="tk.html" class="glass-panel px-3 py-1.5 rounded-xl flex items-center gap-1.5 no-underline mt-2 inline-block">
                <span id="gold-val" class="font-black text-orange-600 text-lg tracking-tight">0</span> ğŸ’°
            </a>
        </div>
        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-3 py-1.5 rounded-xl">
                <span class="text-[9px] font-bold text-stone-500 uppercase leading-none">Khu dá»± Ã¡n</span>
                <div class="font-black text-emerald-700 text-sm"><span id="slot-used">0</span> / <span id="slot-max">2</span></div>
            </div>
            <button id="save-btn" class="glass-panel w-9 h-9 rounded-full flex items-center justify-center shadow-md">ğŸ’¾</button>
        </div>
    </div>

    <div class="absolute top-[145px] left-0 w-full px-5 z-20 flex gap-2">
        <button id="tabMarket" class="flex-1 py-3 rounded-2xl font-black bg-white text-emerald-700 shadow-md">Dá»° ÃN Má»šI</button>
        <button id="tabMyFarms" class="flex-1 py-3 rounded-2xl font-bold bg-white/20 text-white backdrop-blur-sm">Cá»¦A TÃ”I</button>
    </div>

    <div class="scroll-area no-scrollbar" id="main-content"></div>

    <div class="nav-bar">
        <a href="shop.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ›ï¸</span><span class="text-[9px] font-black uppercase tracking-wide">Cá»­a hÃ ng</span></a>
        <a href="kho.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ“¦</span><span class="text-[9px] font-black uppercase tracking-wide">Kho</span></a>
        <a href="trangchu.html" class="nav-center-wrap text-emerald-700"><div class="nav-center-btn"><span class="text-3xl pb-1">ğŸŒ±</span></div><span class="text-[10px] font-black uppercase mt-12 tracking-wider">Äáº§u tÆ°</span></a>
        <a href="gt.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ®</span><span class="text-[9px] font-black uppercase tracking-wide">Giáº£i trÃ­</span></a>
        <a href="tk.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">ğŸ‘¤</span><span class="text-[9px] font-black uppercase tracking-wide">TÃ i khoáº£n</span></a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "nongtraiheocon";

    const PACKAGES = {
        carrot: { id: 'carrot', name: 'Dá»± Ã¡n CÃ  rá»‘t', icon: 'ğŸ¥•', cost: 500, time: 60, exp: 20, yieldName: 'ThÃ¹ng CÃ  rá»‘t', yieldQty: 2, bg: 'from-orange-100' },
        cow: { id: 'cow', name: 'Dá»± Ã¡n BÃ² sá»¯a', icon: 'ğŸ„', cost: 2000, time: 300, exp: 50, yieldName: 'ThÃ¹ng Sá»¯a', yieldQty: 1, bg: 'from-sky-100' },
        chicken: { id: 'chicken', name: 'Dá»± Ã¡n GÃ  trá»©ng', icon: 'ğŸ”', cost: 5000, time: 900, exp: 120, yieldName: 'Vá»‰ Trá»©ng', yieldQty: 3, bg: 'from-yellow-100' },
        sheep: { id: 'sheep', name: 'Dá»± Ã¡n Cá»«u bÃ´ng', icon: 'ğŸ‘', cost: 15000, time: 1800, exp: 300, yieldName: 'Kg BÃ´ng', yieldQty: 2, bg: 'from-slate-200' }
    };

    let state = { gold: 10000, level: 1, exp: 0, maxProjects: 2, investments: [], inventory: { carrot: 0, cow: 0, chicken: 0, sheep: 0 } };
    let currentUser = null;
    let currentTab = 'market';

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await load();
            start();
        } else { window.location.href = 'index.html'; }
    });

    async function load() {
        // TuÃ¢n thá»§ Rule 1: /artifacts/{appId}/users/{userId}/data/global
        const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'global');
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
            const d = snap.data();
            Object.assign(state, d);
            state.investments = (d.investments || []).filter(i => !i.harvested);
        }
        document.getElementById('player-name').innerText = currentUser.displayName || 'NÃ´ng DÃ¢n';
    }

    async function save(notif) {
        if(!currentUser) return;
        const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'global');
        await setDoc(userDocRef, state, { merge: true });
        if(notif) showFloat(window.innerWidth/2, 100, "ÄÃ£ lÆ°u â˜ï¸", "#10b981");
    }

    function start() {
        updateUI(); render();
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('game-container').style.opacity = '1';
        setInterval(updateLoop, 1000);
        setInterval(() => save(false), 30000);
    }

    function switchTab(t) {
        currentTab = t;
        document.getElementById('tabMarket').className = t==='market' ? "flex-1 py-3 rounded-2xl font-black bg-white text-emerald-700 shadow-md" : "flex-1 py-3 rounded-2xl font-bold bg-white/20 text-white backdrop-blur-sm";
        document.getElementById('tabMyFarms').className = t==='myfarms' ? "flex-1 py-3 rounded-2xl font-black bg-white text-emerald-700 shadow-md" : "flex-1 py-3 rounded-2xl font-bold bg-white/20 text-white backdrop-blur-sm";
        render();
    }
    document.getElementById('tabMarket').onclick = () => switchTab('market');
    document.getElementById('tabMyFarms').onclick = () => switchTab('myfarms');

    function render() {
        const c = document.getElementById('main-content'); c.innerHTML = '';
        if(currentTab === 'market') {
            const isFull = state.investments.length >= state.maxProjects;
            if(isFull) {
                const cost = state.maxProjects * 5000;
                c.innerHTML += `<div class="bg-orange-50 p-4 rounded-3xl mb-4 text-center border-2 border-orange-200">
                    <p class="font-black text-orange-700 text-sm mb-2 uppercase">Háº¿t khu dá»± Ã¡n trá»‘ng</p>
                    <button onclick="window.buyLand(${cost})" class="w-full py-3 bg-orange-600 text-white font-black rounded-xl shadow-lg active:scale-95 transition-all">Má» Rá»˜NG (+1): ${cost} ğŸ’°</button>
                </div>`;
            }
            Object.values(PACKAGES).forEach(p => {
                const canAfford = state.gold >= p.cost;
                c.innerHTML += `<div class="glass-panel p-4 rounded-[2rem] mb-4 flex flex-col ${isFull?'opacity-50':''}">
                    <div class="flex gap-4 mb-3">
                        <div class="w-16 h-16 bg-gradient-to-br ${p.bg} to-white rounded-2xl flex items-center justify-center text-4xl shadow-inner border border-white">${p.icon}</div>
                        <div><h3 class="font-black text-stone-800 text-sm">${p.name}</h3><p class="text-[10px] font-bold text-stone-400 uppercase leading-none">Sáº£n lÆ°á»£ng: ${p.yieldQty} ${p.yieldName}</p></div>
                    </div>
                    <button onclick="window.invest('${p.id}')" ${(!canAfford || isFull)?'disabled':''} class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-all">${canAfford ? `Äáº¦U TÆ¯: ${p.cost} ğŸ’°` : 'KHÃ”NG Äá»¦ VÃ€NG'}</button>
                </div>`;
            });
        } else {
            if(state.investments.length === 0) c.innerHTML = `<p class="text-center py-20 font-bold text-stone-400 uppercase tracking-widest opacity-40 text-xs">ChÆ°a cÃ³ dá»± Ã¡n nÃ o Ä‘ang cháº¡y</p>`;
            [...state.investments].reverse().forEach(inv => {
                const p = PACKAGES[inv.pkgId];
                c.innerHTML += `<div class="glass-panel p-4 rounded-[2rem] mb-4">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-black text-stone-700 text-sm">${p.name}</h3><span id="time-${inv.id}" class="text-xs font-black text-emerald-600">--:--</span></div>
                    <div class="progress-bg mb-3"><div id="prog-${inv.id}" class="progress-fill bg-emerald-500" style="width:0%"></div></div>
                    <button id="btn-${inv.id}" disabled class="w-full py-3 bg-stone-200 text-stone-400 font-black rounded-2xl">ÄANG CHÄ‚M SÃ“C</button>
                </div>`;
            });
        }
    }

    window.invest = (id) => {
        const p = PACKAGES[id];
        if(state.gold >= p.cost && state.investments.length < state.maxProjects) {
            state.gold -= p.cost;
            state.investments.push({ id: Date.now().toString(), pkgId: id, startTime: Date.now(), harvested: false });
            updateUI(); save(false); switchTab('myfarms');
        }
    };

    window.buyLand = (cost) => {
        if(state.gold >= cost) { state.gold -= cost; state.maxProjects++; updateUI(); save(false); render(); }
    };

    function updateLoop() {
        if(currentTab !== 'myfarms') return;
        const now = Date.now();
        state.investments.forEach(inv => {
            const p = PACKAGES[inv.pkgId];
            const elapsed = (now - inv.startTime) / 1000;
            const pct = Math.min(100, (elapsed / p.time) * 100);
            const bar = document.getElementById(`prog-${inv.id}`);
            const btn = document.getElementById(`btn-${inv.id}`);
            const txt = document.getElementById(`time-${inv.id}`);
            if(bar) bar.style.width = pct + '%';
            if(txt) txt.innerText = pct >= 100 ? "Xong!" : Math.ceil(p.time - elapsed) + "s";
            if(pct >= 100 && btn && btn.disabled) {
                btn.disabled = false; btn.innerText = "THU HOáº CH"; btn.className = "w-full py-3 bg-emerald-600 text-white font-black rounded-2xl shadow-lg";
                btn.onclick = () => {
                    state.inventory[inv.pkgId] = (state.inventory[inv.pkgId] || 0) + p.yieldQty;
                    state.exp += p.exp;
                    state.investments = state.investments.filter(i => i.id !== inv.id);
                    // Level up
                    if(state.exp >= state.level * 100) { state.exp -= state.level*100; state.level++; state.gold += 1000; }
                    updateUI(); save(false); render();
                };
            }
        });
    }

    function updateUI() {
        document.getElementById('gold-val').innerText = state.gold.toLocaleString();
        document.getElementById('lvl-val').innerText = state.level;
        document.getElementById('slot-used').innerText = state.investments.length;
        document.getElementById('slot-max').innerText = state.maxProjects;
    }

    document.getElementById('save-btn').onclick = () => save(true);
    function showFloat(x, y, t, c) {
        const d = document.createElement('div'); d.className = 'float-info'; d.innerText = t; d.style.left = x + 'px'; d.style.top = y + 'px'; d.style.color = c; document.body.appendChild(d); setTimeout(() => d.remove(), 1000);
    }
</script>
</body>
</html>

