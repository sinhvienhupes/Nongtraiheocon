<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√¥ng Tr·∫°i VIP Pro - ƒê·∫ßu T∆∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Lexend', sans-serif;
            background: #f0f2f5; 
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }

        /* N·ªÅn Header */
        .bg-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 240px;
            background: linear-gradient(135deg, #0f766e, #064e3b);
            border-radius: 0 0 45px 45px; z-index: 0;
            box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
        }

        /* Khung cu·ªôn */
        .scroll-area {
            position: absolute; top: 195px; bottom: 85px; left: 0; width: 100%;
            overflow-y: auto; padding: 0 16px; z-index: 10;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .invest-card { transition: transform 0.1s, box-shadow 0.1s; }
        .invest-card:active { transform: scale(0.98); }

        /* Progress Bar */
        .progress-bg { width: 100%; background: #e5e7eb; border-radius: 999px; height: 12px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 1s linear; }
        
        .ready-pulse { animation: pulseReady 1.5s infinite; }
        @keyframes pulseReady {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6); }
            70% { box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Floating Text */
        .float-info { 
            position: absolute; pointer-events: none; font-weight: 900; 
            font-size: 18px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
            animation: floatUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; z-index: 200; 
        }
        @keyframes floatUp { 
            0% { opacity: 0; transform: translateY(0) scale(0.8); } 
            20% { opacity: 1; transform: translateY(-20px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-70px) scale(1); } 
        }

        /* Nav Bar */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between;
            align-items: center; z-index: 150;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            border-radius: 24px 24px 0 0;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: #9ca3af; transition: all 0.2s; padding-top: 5px;
        }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn {
            position: absolute; top: -30px; width: 65px; height: 65px;
            background: linear-gradient(135deg, #10b981, #047857);
            border: 5px solid #f0f2f5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); transition: transform 0.1s;
        }
        .nav-center-btn:active { transform: scale(0.9); }

        #loading-screen {
            position: fixed; inset: 0; background: #064e3b; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: opacity 0.2s; /* Nhanh h∆°n */
        }
    </style>
</head>
<body>

<!-- Loader si√™u t·ªëc -->
<div id="loading-screen">
    <div class="text-6xl animate-bounce mb-3">üöÄ</div>
    <h2 class="text-xl font-black mb-1 tracking-widest text-emerald-300">ƒêANG ƒê·ªíNG B·ªò...</h2>
</div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-300">
    
    <div class="bg-header"></div>

    <!-- TOP BAR -->
    <div class="absolute top-5 left-0 w-full px-5 flex justify-between items-start z-50">
        <div class="flex flex-col gap-2">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-xl shadow-sm">üë®‚Äçüåæ</div>
                <div>
                    <h1 id="player-name" class="text-white text-base font-black shadow-sm leading-tight">Kh√°ch</h1>
                    <p class="text-emerald-200 text-[10px] font-bold uppercase tracking-wide">C·∫•p ƒë·ªô <span id="lvl-val">1</span></p>
                </div>
            </div>
            <a href="tk.html" class="glass-panel px-3 py-1.5 rounded-xl flex items-center gap-1.5 active:scale-95 transition-transform w-fit no-underline mt-1">
                <span class="text-lg">üí∞</span>
                <span id="gold-val" class="font-black text-orange-600 text-lg tracking-tight">---</span>
            </a>
        </div>
        
        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-3 py-1.5 rounded-xl flex flex-col items-end text-right">
                <span class="text-[9px] font-bold text-stone-500 uppercase">Khu ƒë·∫•t d·ª± √°n</span>
                <div class="font-black text-emerald-700 text-sm">
                    <span id="slot-used">0</span> / <span id="slot-max">2</span>
                </div>
            </div>
            <button id="save-btn" class="glass-panel w-9 h-9 rounded-full flex items-center justify-center active:scale-95 transition-transform text-sm shadow-md">
                üíæ
            </button>
        </div>
    </div>

    <!-- TABS -->
    <div class="absolute top-[145px] left-0 w-full px-5 z-20 flex gap-2">
        <button id="tab-market" class="flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-emerald-700 shadow-md">D·ª± √Ån M·ªõi</button>
        <button id="tab-myfarms" class="flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm">Trang Tr·∫°i C·ªßa T√¥i</button>
    </div>

    <!-- V√ôNG CU·ªòN -->
    <div class="scroll-area no-scrollbar" id="main-content">
        <!-- Render n·ªôi dung -->
    </div>

    <!-- UI: NAVIGATION BAR -->
    <div class="nav-bar">
        <a href="shop.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üõçÔ∏è</span>
            <span class="text-[9px] font-black uppercase tracking-wide">C·ª≠a h√†ng</span>
        </a>
        <a href="kho.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üì¶</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Kho</span>
        </a>
        
        <a href="trangchu.html" class="nav-center-wrap text-emerald-700">
            <div class="nav-center-btn">
                <span class="text-3xl pb-1">üå±</span>
            </div>
            <span class="text-[10px] font-black uppercase mt-12 tracking-wider">ƒê·∫ßu t∆∞</span>
        </a>
        
        <a href="gt.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üéÆ</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Gi·∫£i tr√≠</span>
        </a>
        <a href="tk.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üë§</span>
            <span class="text-[9px] font-black uppercase tracking-wide">T√†i kho·∫£n</span>
        </a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45",
      measurementId: "G-RT8HPTJERF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ================= D·ªÆ LI·ªÜU C√ÅC G√ìI ƒê·∫¶U T∆Ø =================
    // Thay v√¨ thu V√†ng, b√¢y gi·ªù thu ƒë∆∞·ª£c N√¥ng S·∫£n (Item)
    const PACKAGES = {
        carrot: { 
            id: 'carrot', name: 'Trang tr·∫°i C√† r·ªët', icon: 'ü•ï', 
            cost: 500, time: 60, exp: 20, 
            yieldName: 'Th√πng C√† r·ªët', yieldQty: 2,
            bg: 'from-orange-100 to-orange-50', text: 'text-orange-600'
        },
        cow: { 
            id: 'cow', name: 'N√¥ng tr·∫°i B√≤ s·ªØa', icon: 'üêÑ', 
            cost: 2000, time: 300, exp: 50, 
            yieldName: 'Th√πng S·ªØa', yieldQty: 1,
            bg: 'from-sky-100 to-blue-50', text: 'text-blue-600'
        },
        chicken: { 
            id: 'chicken', name: 'Trang tr·∫°i G√† ƒë·∫ª', icon: 'üêî', 
            cost: 5000, time: 900, exp: 120, 
            yieldName: 'V·ªâ Tr·ª©ng', yieldQty: 3,
            bg: 'from-yellow-100 to-yellow-50', text: 'text-yellow-600'
        },
        sheep: { 
            id: 'sheep', name: 'N√¥ng tr·∫°i C·ª´u', icon: 'üêë', 
            cost: 15000, time: 1800, exp: 300, 
            yieldName: 'Kg B√¥ng', yieldQty: 2,
            bg: 'from-slate-200 to-slate-100', text: 'text-slate-600'
        }
    };

    // ================= TR·∫†NG TH√ÅI GAME =================
    let state = {
        gold: 10000,
        level: 1,
        exp: 0,
        maxProjects: 2, // M·∫∑c ƒë·ªãnh ch·ªâ c√≥ 2 khu ƒë·∫•t
        investments: [], 
        inventory: { carrot: 0, cow: 0, chicken: 0, sheep: 0 } // S·ªë l∆∞·ª£ng n√¥ng s·∫£n thu ƒë∆∞·ª£c
    };

    let currentUser = null;
    let currentTab = 'market'; 
    let timerInterval;

    const DOM = {
        loading: document.getElementById('loading-screen'),
        container: document.getElementById('game-container'),
        content: document.getElementById('main-content'),
        goldVal: document.getElementById('gold-val'),
        lvlVal: document.getElementById('lvl-val'),
        slotUsed: document.getElementById('slot-used'),
        slotMax: document.getElementById('slot-max'),
        tabMarket: document.getElementById('tab-market'),
        tabMyFarms: document.getElementById('tab-myfarms')
    };

    // ================= FIREBASE LOGIC =================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('player-name').innerText = user.displayName || 'Nh√† ƒê·∫ßu T∆∞';
            await loadGameFromCloud();
            startGame();
        } else {
            window.location.href = 'index.html';
        }
    });

    async function loadGameFromCloud() {
        try {
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                state.gold = data.gold ?? 10000;
                state.level = data.level || 1;
                state.exp = data.exp || 0;
                state.maxProjects = data.maxProjects || 2;
                state.inventory = { ...state.inventory, ...data.inventory };
                state.investments = (data.investments || []).filter(inv => !inv.harvested);
            }
        } catch (e) { console.error("L·ªói t·∫£i:", e); }
    }

    async function saveGameToCloud(showNotif = false) {
        if(!currentUser) return;
        try {
            await setDoc(doc(db, "users", currentUser.uid), {
                gold: state.gold, level: state.level, exp: state.exp,
                maxProjects: state.maxProjects, inventory: state.inventory,
                investments: state.investments, lastSaved: new Date()
            }, { merge: true });
            if(showNotif) showFloat(window.innerWidth/2, 100, "ƒê√£ l∆∞u ‚òÅÔ∏è", "#10b981");
        } catch(e) { console.error("L·ªói l∆∞u:", e); }
    }

    document.getElementById('save-btn').addEventListener('click', () => saveGameToCloud(true));

    // ================= KH·ªûI ƒê·ªòNG NHANH =================
    function startGame() {
        updateUI();
        renderContent();
        
        // T·∫Øt m√†n loading ngay l·∫≠p t·ª©c
        DOM.loading.style.opacity = '0';
        setTimeout(() => {
            DOM.loading.style.display = 'none';
            DOM.container.style.opacity = '1';
        }, 100);

        timerInterval = setInterval(updateProgressBars, 1000);
        setInterval(() => saveGameToCloud(false), 20000); 
    }

    // ================= CHUY·ªÇN TAB =================
    DOM.tabMarket.addEventListener('click', () => switchTab('market'));
    DOM.tabMyFarms.addEventListener('click', () => switchTab('myfarms'));

    function switchTab(tab) {
        currentTab = tab;
        if(tab === 'market') {
            DOM.tabMarket.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-emerald-700 shadow-md";
            DOM.tabMyFarms.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm";
        } else {
            DOM.tabMyFarms.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-emerald-700 shadow-md";
            DOM.tabMarket.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm";
        }
        renderContent();
    }

    function renderContent() {
        DOM.content.innerHTML = '';
        if(currentTab === 'market') renderMarket();
        else renderMyFarms();
    }

    // --- TAB 1: TH·ªä TR∆Ø·ªúNG ---
    function renderMarket() {
        const wrapper = document.createElement('div');
        wrapper.className = "space-y-4 pb-10";
        
        const isFull = state.investments.length >= state.maxProjects;

        // B·∫£ng Mua ƒê·∫•t (Ch·ªâ hi·ªán khi ƒë√£ d√πng h·∫øt slot)
        if (isFull) {
            const landCost = state.maxProjects * 5000; // C√¥ng th·ª©c t√≠nh gi√° ƒë·∫•t: 2->10k, 3->15k...
            const canBuyLand = state.gold >= landCost;
            
            const landCard = document.createElement('div');
            landCard.className = "bg-gradient-to-r from-red-100 to-rose-50 p-4 rounded-3xl border-2 border-red-200 shadow-sm flex flex-col items-center text-center";
            landCard.innerHTML = `
                <div class="text-3xl mb-1">üöß</div>
                <h3 class="font-black text-red-700 mb-1">ƒê√É H·∫æT KHU ƒê·∫§T TR·ªêNG</h3>
                <p class="text-xs text-red-600 mb-3 px-4">B·∫°n ƒëang ch·∫°y t·ªëi ƒëa ${state.maxProjects} d·ª± √°n. Mua th√™m khu ƒë·∫•t m·ªõi ƒë·ªÉ m·ªü r·ªông kinh doanh!</p>
                <button class="w-full py-3 rounded-xl font-black text-white shadow-md transition-colors ${canBuyLand ? 'bg-red-600 hover:bg-red-700' : 'bg-red-300'}" 
                        ${canBuyLand ? '' : 'disabled'}
                        onclick="buyLand(${landCost}, event)">
                    ${canBuyLand ? `M·ªû R·ªòNG KHU (${landCost.toLocaleString()} üí∞)` : 'CH∆ØA ƒê·ª¶ V√ÄNG M·ªû R·ªòNG'}
                </button>
            `;
            wrapper.appendChild(landCard);
        }

        // Danh s√°ch G√≥i
        Object.values(PACKAGES).forEach(pkg => {
            const canAfford = state.gold >= pkg.cost;
            const card = document.createElement('div');
            card.className = `invest-card bg-gradient-to-br ${pkg.bg} p-4 rounded-3xl border border-white shadow-sm flex flex-col ${isFull ? 'opacity-50 grayscale-[50%]' : ''}`;
            
            card.innerHTML = `
                <div class="flex gap-4 items-center mb-3">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-4xl shadow-sm shrink-0">
                        ${pkg.icon}
                    </div>
                    <div>
                        <h3 class="font-black text-[17px] text-stone-800 leading-tight mb-1">${pkg.name}</h3>
                        <p class="text-xs text-stone-600 font-medium">Thu v·ªÅ: <span class="font-black ${pkg.text}">${pkg.yieldQty} ${pkg.yieldName}</span></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-white/60 p-2 rounded-xl text-center">
                        <p class="text-[10px] text-stone-500 font-bold uppercase">Th·ªùi gian</p>
                        <p class="font-black text-stone-700">${formatTime(pkg.time)}</p>
                    </div>
                    <div class="bg-white/60 p-2 rounded-xl text-center">
                        <p class="text-[10px] text-stone-500 font-bold uppercase">Kinh nghi·ªám</p>
                        <p class="font-black text-blue-600">+${pkg.exp} EXP</p>
                    </div>
                </div>
                <button class="w-full py-3.5 rounded-xl font-black text-white shadow-md transition-colors ${canAfford && !isFull ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-stone-300'}" 
                        ${(!canAfford || isFull) ? 'disabled' : ''}
                        onclick="invest('${pkg.id}', event)">
                    ${isFull ? 'H·∫æT CH·ªñ TR·ªêNG' : canAfford ? `ƒê·∫¶U T∆Ø (${pkg.cost.toLocaleString()} üí∞)` : 'CH∆ØA ƒê·ª¶ V√ÄNG'}
                </button>
            `;
            wrapper.appendChild(card);
        });
        DOM.content.appendChild(wrapper);
    }

    // --- TAB 2: TRANG TR·∫†I C·ª¶A T√îI ---
    function renderMyFarms() {
        const wrapper = document.createElement('div');
        wrapper.className = "space-y-4 pb-10";

        if(state.investments.length === 0) {
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 opacity-50">
                    <span class="text-6xl mb-4 grayscale">üöú</span>
                    <p class="font-bold text-stone-600">B·∫°n ch∆∞a c√≥ d·ª± √°n n√†o.</p>
                </div>
            `;
            DOM.content.appendChild(wrapper);
            return;
        }

        [...state.investments].reverse().forEach(inv => {
            const pkg = PACKAGES[inv.pkgId];
            if(!pkg) return;

            const card = document.createElement('div');
            card.className = `glass-panel p-4 rounded-3xl relative overflow-hidden invest-card`;
            card.id = `inv-card-${inv.id}`;
            
            card.innerHTML = `
                <div class="flex gap-4 items-center mb-4">
                    <div class="w-14 h-14 bg-gradient-to-br ${pkg.bg} rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white shrink-0">
                        ${pkg.icon}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="font-black text-[15px] text-stone-800">${pkg.name}</h3>
                            <span class="font-black ${pkg.text}">+${pkg.yieldQty}</span>
                        </div>
                        <p class="text-[11px] text-stone-500 font-bold mb-1 status-text" id="status-${inv.id}">ƒêang sinh tr∆∞·ªüng...</p>
                        
                        <div class="progress-bg">
                            <div class="progress-fill bg-emerald-500" id="prog-${inv.id}" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <button class="w-full py-3 rounded-xl font-black text-white bg-emerald-500 opacity-50 cursor-not-allowed transition-all harvest-btn" 
                        id="btn-${inv.id}" disabled>
                    ƒêANG TR·ªíNG (<span id="time-${inv.id}">--:--</span>)
                </button>
            `;
            wrapper.appendChild(card);
        });

        DOM.content.appendChild(wrapper);
        updateProgressBars(); 
    }

    // ================= LOGIC GAME =================
    window.invest = function(pkgId, e) {
        if(state.investments.length >= state.maxProjects) return;
        
        const pkg = PACKAGES[pkgId];
        if(state.gold >= pkg.cost) {
            state.gold -= pkg.cost;
            state.investments.push({
                id: Date.now().toString(),
                pkgId: pkgId,
                startTime: Date.now(),
                harvested: false
            });
            
            updateUI();
            saveGameToCloud();
            
            const rect = e.target.getBoundingClientRect();
            showFloat(rect.left + rect.width/2, rect.top, `-${pkg.cost} üí∞`, "#ef4444");
            setTimeout(() => switchTab('myfarms'), 200);
        }
    };

    window.buyLand = function(cost, e) {
        if(state.gold >= cost) {
            state.gold -= cost;
            state.maxProjects++;
            updateUI();
            saveGameToCloud();
            const rect = e.target.getBoundingClientRect();
            showFloat(rect.left + rect.width/2, rect.top, `+1 Khu ƒê·∫•t`, "#10b981");
        }
    }

    window.harvest = function(invId, e) {
        const invIndex = state.investments.findIndex(i => i.id === invId);
        if(invIndex === -1) return;
        
        const inv = state.investments[invIndex];
        const pkg = PACKAGES[inv.pkgId];

        // Thu ho·∫°ch N√îNG S·∫¢N thay v√¨ v√†ng
        state.inventory[pkg.id] = (state.inventory[pkg.id] || 0) + pkg.yieldQty;
        addExp(pkg.exp);
        
        state.investments.splice(invIndex, 1);
        updateUI();
        saveGameToCloud();
        
        const rect = e.target.getBoundingClientRect();
        showFloat(rect.left + rect.width/2, rect.top, `+${pkg.yieldQty} ${pkg.yieldName}`, "#f59e0b");
        
        const card = document.getElementById(`inv-card-${invId}`);
        if(card) {
            card.style.transform = "scale(0.8)"; card.style.opacity = "0";
            setTimeout(() => { card.remove(); if(state.investments.length === 0) renderMyFarms(); }, 300);
        }
    };

    function addExp(amount) {
        state.exp += amount;
        let maxExp = state.level * 100;
        if(state.exp >= maxExp) {
            state.exp -= maxExp;
            state.level++;
            showFloat(window.innerWidth/2, 150, `üéâ L√™n C·∫•p ${state.level}!`, "#3b82f6");
        }
    }

    // ================= LOOP UPDATE =================
    function updateProgressBars() {
        if(currentTab !== 'myfarms') return;

        const now = Date.now();
        state.investments.forEach(inv => {
            const pkg = PACKAGES[inv.pkgId];
            if(!pkg) return;

            const elapsedSec = (now - inv.startTime) / 1000;
            let percent = (elapsedSec / pkg.time) * 100;
            
            const bar = document.getElementById(`prog-${inv.id}`);
            const btn = document.getElementById(`btn-${inv.id}`);
            const timeTxt = document.getElementById(`time-${inv.id}`);
            const statusTxt = document.getElementById(`status-${inv.id}`);

            if(!bar || !btn) return;

            if (percent >= 100) {
                percent = 100;
                bar.style.width = '100%';
                bar.className = "progress-fill bg-emerald-500";
                
                statusTxt.innerText = "S·∫µn s√†ng thu ho·∫°ch!";
                statusTxt.className = "text-[11px] font-black mb-1 text-emerald-600";
                
                if(btn.disabled) {
                    btn.disabled = false;
                    btn.className = "w-full py-3 rounded-xl font-black text-white bg-emerald-500 hover:bg-emerald-600 shadow-lg shadow-emerald-200 ready-pulse active:scale-95 transition-all";
                    btn.innerHTML = `THU HO·∫†CH L·∫§Y ${pkg.yieldQty} ${pkg.yieldName.toUpperCase()}`;
                    btn.onclick = (e) => harvest(inv.id, e);
                }
            } else {
                bar.style.width = `${percent}%`;
                const remSec = Math.ceil(pkg.time - elapsedSec);
                timeTxt.innerText = formatTime(remSec);
            }
        });
    }

    // ================= C√îNG C·ª§ H·ªñ TR·ª¢ =================
    function updateUI() {
        DOM.goldVal.innerText = state.gold.toLocaleString();
        DOM.lvlVal.innerText = state.level;
        DOM.slotUsed.innerText = state.investments.length;
        DOM.slotMax.innerText = state.maxProjects;
        
        let maxExp = state.level * 100;
        
        // C·∫≠p nh·∫≠t thanh EXP an to√†n
        if (DOM.expBar) {
             DOM.expBar.style.width = `${(state.exp / maxExp) * 100}%`;
        }
        
        if(currentTab === 'market') renderMarket();
    }

    function formatTime(seconds) {
        if(seconds < 60) return `${seconds}s`;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        if(m < 60) return `${m}p ${s}s`;
        const h = Math.floor(m / 60);
        const rm = m % 60;
        return `${h}h ${rm}p`;
    }

    function showFloat(x, y, txt, color) {
        const div = document.createElement('div');
        div.className = 'float-info'; div.innerText = txt;
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.color = color;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    }

</script>

</body>
</html>


