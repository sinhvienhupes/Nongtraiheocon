<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√¥ng Tr·∫°i VIP Pro - Trang Ch·ªß</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Lexend', sans-serif;
            background: #113624; /* Xanh l√° th·∫´m l√†m n·ªÅn */
            user-select: none; -webkit-user-select: none; touch-action: none;
        }

        .isometric-canvas { display: block; touch-action: none; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .tool-tray {
            position: absolute; bottom: 95px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 100; pointer-events: auto;
            padding: 8px; border-radius: 20px;
        }
        .tool-item {
            width: 50px; height: 50px; border-radius: 14px; 
            display: flex; align-items: center; justify-content: center; font-size: 24px;
            background: white; border: 2px solid transparent; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: visible;
        }
        
        .tool-item.selected { 
            border-color: #f59e0b; transform: translateY(-8px) scale(1.1); 
            background: #fffbeb; box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3); 
        }
        .tool-badge {
            position: absolute; top: -5px; right: -5px;
            background: #ef4444; color: white; font-size: 10px; font-weight: 900;
            padding: 2px 6px; border-radius: 10px; border: 2px solid white; z-index: 2;
        }

        .float-info { 
            position: absolute; pointer-events: none; font-weight: 900; 
            font-size: 16px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            animation: floatUp 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; z-index: 200; 
        }
        @keyframes floatUp { 
            0% { opacity: 0; transform: translateY(10px) scale(0.8); } 
            20% { opacity: 1; transform: translateY(-10px) scale(1.1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1); } 
        }

        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between;
            align-items: center; z-index: 150;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1);
            padding-bottom: env(safe-area-inset-bottom);
            border-radius: 30px 30px 0 0;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: #9ca3af; transition: all 0.2s; padding-top: 5px;
        }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn {
            position: absolute; top: -35px; width: 70px; height: 70px;
            background: linear-gradient(135deg, #22c55e, #15803d);
            border: 6px solid #f0fdf4; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(22, 163, 74, 0.4); transition: transform 0.2s;
        }
        .nav-center-btn:active { transform: scale(0.9); }
        
        .exp-bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; margin-top: 2px;}
        .exp-bar-fill { height: 100%; background: #3b82f6; transition: width 0.3s; }

        /* Loader */
        #loading-screen {
            position: fixed; inset: 0; background: #113624; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<!-- M√†n h√¨nh t·∫£i -->
<div id="loading-screen">
    <div class="text-6xl animate-bounce mb-4">üê∑</div>
    <h2 class="text-2xl font-black mb-2 tracking-widest text-green-300">ƒêANG T·∫¢I...</h2>
    <p id="loading-text" class="text-sm font-semibold text-green-100 opacity-70">Kh·ªüi t·∫°o ƒë·ªì h·ªça</p>
</div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-1000">
    <canvas id="farmCanvas" class="isometric-canvas"></canvas>

    <!-- UI: TOP BAR -->
    <div class="absolute top-4 left-0 w-full px-4 flex justify-between items-start z-50 pointer-events-none">
        
        <div class="flex flex-col gap-2">
            <div class="glass-panel px-4 py-2.5 rounded-2xl flex flex-col shadow-lg pointer-events-auto min-w-[140px]">
                <div class="flex justify-between items-center w-full">
                    <span class="text-xs font-bold text-stone-500 uppercase">C·∫•p ƒë·ªô <span id="lvl-val" class="text-blue-600 font-black text-sm">1</span></span>
                    <span id="exp-val" class="text-[10px] text-stone-400 font-bold">0/100</span>
                </div>
                <div class="exp-bar-bg"><div id="exp-bar" class="exp-bar-fill" style="width: 0%;"></div></div>
            </div>

            <a href="tk.html" class="glass-panel px-4 py-2 rounded-2xl flex items-center gap-2 shadow-lg pointer-events-auto no-underline active:scale-95 transition-transform">
                <span class="text-xl">üí∞</span>
                <span id="gold-val" class="font-black text-orange-600 text-lg">---</span>
                <div class="w-5 h-5 rounded-full bg-orange-100 flex items-center justify-center ml-auto">
                    <span class="text-[10px] text-orange-600 font-black">+</span>
                </div>
            </a>
        </div>

        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-3 py-2 rounded-xl flex items-center gap-2 shadow-lg pointer-events-auto">
                <span class="text-xl">‚òÄÔ∏è</span>
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-stone-400 uppercase leading-tight">N√¥ng d√¢n</span>
                    <span id="player-name" class="text-xs font-black text-green-700 leading-tight">Kh√°ch</span>
                </div>
            </div>
            
            <button id="save-btn" class="glass-panel w-10 h-10 rounded-xl flex items-center justify-center shadow-lg pointer-events-auto active:scale-95 transition-transform text-lg">
                üíæ
            </button>
        </div>
    </div>

    <!-- UI: TOOL TRAY -->
    <div class="tool-tray glass-panel" id="tool-tray">
        <div class="tool-item selected" data-tool="hand" title="Ch·ªçn">üñêÔ∏è</div>
        <div class="tool-item" data-tool="scythe" title="Thu ho·∫°ch">ü™ì</div>
        <div class="tool-item" data-tool="water" title="T∆∞·ªõi n∆∞·ªõc">üíß<span class="tool-badge" id="b-water">0</span></div>
        <div class="tool-item" data-tool="fertilizer" title="B√≥n ph√¢n">üí©<span class="tool-badge" id="b-fert">0</span></div>
        <div class="tool-item" data-tool="seed" title="Gieo h·∫°t">üå±<span class="tool-badge" id="b-seed">0</span></div>
        <div class="tool-item" data-tool="hoe" title="M·ªü ƒë·∫•t/N√¢ng c·∫•p">üî®</div>
    </div>

    <!-- UI: NAVIGATION BAR -->
    <div class="nav-bar">
        <a href="shop.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üõçÔ∏è</span>
            <span class="text-[9px] font-black uppercase tracking-wide">C·ª≠a h√†ng</span>
        </a>
        <a href="kho.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üì¶</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Kho</span>
        </a>
        
        <a href="trangchu.html" class="nav-center-wrap text-green-700">
            <div class="nav-center-btn">
                <span class="text-3xl">üè†</span>
            </div>
            <span class="text-[10px] font-black uppercase mt-12 tracking-wider">Trang tr·∫°i</span>
        </a>
        
        <a href="gt.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üéÆ</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Gi·∫£i tr√≠</span>
        </a>
        <a href="tk.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üë§</span>
            <span class="text-[9px] font-black uppercase tracking-wide">T√†i kho·∫£n</span>
        </a>
    </div>
</div>

<script type="module">
    // ================= FIREBASE CONFIG =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45",
      measurementId: "G-RT8HPTJERF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ================= KH·ªûI T·∫†O ƒê·ªí H·ªåA (NH√öNG TR·ª∞C TI·∫æP SVG CHU·∫®N) =================
    // S·ª≠ d·ª•ng Data URI SVG ƒë·ªÉ ƒë·∫£m b·∫£o 100% kh√¥ng bao gi·ªù l·ªói h√¨nh ·∫£nh
    const ASSETS = {};
    function loadSVGImage(svgString) {
        const img = new Image();
        img.src = "data:image/svg+xml;utf8," + encodeURIComponent(svgString);
        return img;
    }

    // Kh·ªëi ƒë·∫•t Kh√≥a
    ASSETS.locked = loadSVGImage(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <polygon points='50,25 100,50 50,75 0,50' fill='#64748b'/>
            <polygon points='0,50 50,75 50,85 0,60' fill='#475569'/>
            <polygon points='50,75 100,50 100,60 50,85' fill='#334155'/>
        </svg>`);
    
    // Kh·ªëi ƒë·∫•t Th∆∞·ªùng
    ASSETS.soil1 = loadSVGImage(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <polygon points='50,25 100,50 50,75 0,50' fill='#8b5a2b'/>
            <polygon points='0,50 50,75 50,85 0,60' fill='#6b4423'/>
            <polygon points='50,75 100,50 100,60 50,85' fill='#50331a'/>
        </svg>`);

    // Kh·ªëi ƒë·∫•t VIP
    ASSETS.soil2 = loadSVGImage(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <polygon points='50,25 100,50 50,75 0,50' fill='#a67b5b'/>
            <polygon points='0,50 50,75 50,85 0,60' fill='#8a6244'/>
            <polygon points='50,75 100,50 100,60 50,85' fill='#6f4f36'/>
        </svg>`);

    // Vi·ªÅn s√°ng khi hover
    ASSETS.highlight = loadSVGImage(`
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <polygon points='50,25 100,50 50,75 0,50' fill='rgba(255,255,255,0.2)' stroke='white' stroke-width='3'/>
        </svg>`);

    // H√¨nh ·∫£nh C√¢y tr·ªìng (M·∫ßm, ƒêang l·ªõn, Ch√≠n)
    ASSETS.cropSeed = loadSVGImage(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='65' font-size='40' text-anchor='middle'>üå±</text></svg>`);
    ASSETS.cropGrow = loadSVGImage(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='65' font-size='50' text-anchor='middle'>üåø</text></svg>`);
    ASSETS.cornReady = loadSVGImage(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='65' font-size='60' text-anchor='middle'>üåΩ</text></svg>`);
    ASSETS.pumpkinReady = loadSVGImage(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text x='50' y='65' font-size='60' text-anchor='middle'>üéÉ</text></svg>`);

    // ================= D·ªÆ LI·ªÜU C·ªê ƒê·ªäNH =================
    const CROPS = {
        corn: { id: 'corn', name: 'Ng√¥', emoji: 'üåΩ', time: 10, exp: 10, yield: 2, 
                imgStages: [ASSETS.cropSeed, ASSETS.cropGrow, ASSETS.cornReady] },
        pumpkin: { id: 'pumpkin', name: 'B√≠ Ng√¥', emoji: 'üéÉ', time: 20, exp: 25, yield: 1,
                imgStages: [ASSETS.cropSeed, ASSETS.cropGrow, ASSETS.pumpkinReady] }
    };

    const LAND_TIERS = [
        { name: 'Kh√≥a', cost: 500, img: ASSETS.locked },
        { name: 'ƒê·∫•t Th∆∞·ªùng', speed: 1.0, cost: 0, img: ASSETS.soil1 },
        { name: 'ƒê·∫•t T·ªët', speed: 1.5, cost: 2000, img: ASSETS.soil2 }
    ];

    const gridSize = 8;
    // K√≠ch th∆∞·ªõc chu·∫©n cho ng√≥i Isometric 2:1
    const tileW = 120;
    const tileH = 60; 

    // ================= TR·∫†NG TH√ÅI GAME =================
    let state = {
        gold: 1000,
        level: 1,
        exp: 0,
        currentTool: 'hand',
        selectedSeed: 'corn',
        inventory: {
            seeds: { corn: 10, pumpkin: 5 },
            crops: { corn: 0, pumpkin: 0 },
            tools: { water: 15, fertilizer: 5 }
        },
        plots: []
    };

    let camera = { x: 0, y: 0 };
    let drag = { isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0, moved: false };
    let hoveredTile = { i: -1, j: -1 }; 

    let currentUser = null;
    let gameLoopId;

    const canvas = document.getElementById('farmCanvas');
    const ctx = canvas.getContext('2d');
    const loadingScreen = document.getElementById('loading-screen');
    const gameContainer = document.getElementById('game-container');

    // ================= FIREBASE LOGIC =================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('player-name').innerText = user.displayName || 'N√¥ng D√¢n';
            await loadGameFromCloud();
            startGame();
        } else {
            window.location.href = 'index.html';
        }
    });

    function createEmptyFarm() {
        let arr = [];
        for(let i=0; i<gridSize; i++) {
            arr[i] = [];
            for(let j=0; j<gridSize; j++) {
                let isUnlocked = (i < 2 && j < 2);
                arr[i][j] = {
                    tier: isUnlocked ? 1 : 0,
                    seedKey: null,
                    progress: 0,
                    isWatered: false,
                    isFertilized: false,
                    status: 'empty', 
                    lastTick: Date.now()
                };
            }
        }
        return arr;
    }

    async function loadGameFromCloud() {
        try {
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                state.gold = data.gold || 1000;
                state.level = data.level || 1;
                state.exp = data.exp || 0;
                state.inventory = { ...state.inventory, ...data.inventory };
                
                let savedPlots = data.plots;
                let now = Date.now();
                if(savedPlots && savedPlots.length > 0) {
                    state.plots = savedPlots.map(row => row.map(p => {
                        if(p.status === 'growing') {
                            let offlineSeconds = (now - p.lastTick) / 1000;
                            if(offlineSeconds < 0) offlineSeconds = 0; 
                            const crop = CROPS[p.seedKey];
                            if(crop) {
                                let multi = LAND_TIERS[p.tier].speed;
                                if(p.isWatered) multi *= 1.5;
                                if(p.isFertilized) multi *= 2.0;
                                p.progress += (100 / crop.time) * multi * offlineSeconds;
                                if(p.progress >= 100) { p.progress = 100; p.status = 'ready'; }
                            }
                        }
                        p.lastTick = now;
                        return p;
                    }));
                } else {
                    state.plots = createEmptyFarm();
                }
            } else {
                state.plots = createEmptyFarm();
                await saveGameToCloud(false); 
            }
        } catch (e) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu Cloud:", e);
            state.plots = createEmptyFarm(); 
        }
    }

    async function saveGameToCloud(showNotif = false) {
        if(!currentUser) return;
        state.plots.forEach(row => row.forEach(p => p.lastTick = Date.now()));
        try {
            await setDoc(doc(db, "users", currentUser.uid), {
                gold: state.gold, level: state.level, exp: state.exp,
                inventory: state.inventory, plots: state.plots, lastSaved: new Date()
            }, { merge: true });
            if(showNotif) showFloat(window.innerWidth/2, 100, "ƒê√£ l∆∞u l√™n ƒê√°m m√¢y ‚òÅÔ∏è", "#22c55e");
        } catch(e) {
            console.error("L·ªói l∆∞u Cloud:", e);
            if(showNotif) showFloat(window.innerWidth/2, 100, "L·ªói m·∫°ng!", "#ef4444");
        }
    }

    document.getElementById('save-btn').addEventListener('click', () => {
        saveGameToCloud(true);
    });

    // ================= KH·ªûI ƒê·ªòNG GAME =================
    function startGame() {
        resize();
        camera.x = canvas.width / 2; 
        camera.y = canvas.height / 4;

        setupListeners();
        updateUI();

        loadingScreen.style.opacity = '0';
        setTimeout(() => {
            loadingScreen.style.display = 'none';
            gameContainer.style.opacity = '1';
        }, 500);

        gameLoopId = requestAnimationFrame(gameLoop);
        setInterval(() => saveGameToCloud(false), 30000);
    }

    function setupListeners() {
        window.addEventListener('resize', resize);
        
        document.querySelectorAll('.tool-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.tool-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                state.currentTool = item.dataset.tool;
            });
        });

        canvas.addEventListener('mousedown', onDragStart);
        window.addEventListener('mousemove', onDragMove);
        window.addEventListener('mouseup', onDragEnd);

        canvas.addEventListener('touchstart', (e) => onDragStart(e.touches[0]), {passive: false});
        window.addEventListener('touchmove', (e) => { e.preventDefault(); onDragMove(e.touches[0]); }, {passive: false});
        window.addEventListener('touchend', onDragEnd);
    }

    // --- PAN CAMERA & HOVER ---
    function onDragStart(e) {
        drag.isDragging = true; drag.moved = false;
        drag.startX = e.clientX; drag.startY = e.clientY;
        drag.lastX = e.clientX; drag.lastY = e.clientY;
    }
    
    function onDragMove(e) {
        const rect = canvas.getBoundingClientRect();
        const sx = e.clientX - rect.left; const sy = e.clientY - rect.top;
        hoveredTile = screenToGrid(sx, sy);

        if(!drag.isDragging) return;
        const dx = e.clientX - drag.lastX;
        const dy = e.clientY - drag.lastY;
        
        if(Math.abs(e.clientX - drag.startX) > 5 || Math.abs(e.clientY - drag.startY) > 5) drag.moved = true;

        camera.x += dx; camera.y += dy;

        const minX = -canvas.width; const maxX = canvas.width * 2;
        const minY = -canvas.height; const maxY = canvas.height * 1.5;
        camera.x = Math.max(minX, Math.min(maxX, camera.x));
        camera.y = Math.max(minY, Math.min(maxY, camera.y));

        drag.lastX = e.clientX; drag.lastY = e.clientY;
    }
    
    function onDragEnd(e) {
        drag.isDragging = false;
        if(!drag.moved) handleAction(drag.startX, drag.startY);
    }

    // --- T∆Ø∆†NG T√ÅC ƒê·∫§T ---
    function handleAction(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const sx = clientX - rect.left; const sy = clientY - rect.top;
        const grid = screenToGrid(sx, sy);
        if(grid.i >= 0 && grid.i < gridSize && grid.j >= 0 && grid.j < gridSize) {
            applyTool(grid.i, grid.j, sx, sy);
        }
    }

    function applyTool(i, j, sx, sy) {
        const p = state.plots[i][j];

        if(p.tier === 0) {
            if (state.currentTool === 'hoe' || state.currentTool === 'hand') {
                if(state.gold >= LAND_TIERS[0].cost) {
                    state.gold -= LAND_TIERS[0].cost;
                    p.tier = 1;
                    showFloat(sx, sy, "üîì M·ªü kh√≥a ƒë·∫•t", "#f59e0b");
                    updateUI();
                } else showFloat(sx, sy, "Thi·∫øu v√†ng!", "#ef4444");
            }
            return;
        }

        switch(state.currentTool) {
            case 'hand':
            case 'scythe':
                if(p.status === 'ready') harvest(i, j, sx, sy);
                else if(p.status === 'growing') showFloat(sx, sy, "‚è≥ Ch∆∞a ch√≠n!", "#9ca3af");
                break;
            case 'water':
                if(p.status === 'growing' && !p.isWatered) {
                    if(state.inventory.tools.water > 0) {
                        p.isWatered = true; state.inventory.tools.water--;
                        showFloat(sx, sy, "üíß ƒê√£ t∆∞·ªõi", "#3b82f6");
                        updateUI();
                    } else showFloat(sx, sy, "H·∫øt n∆∞·ªõc!", "#ef4444");
                }
                break;
            case 'fertilizer':
                if(p.status === 'growing' && !p.isFertilized) {
                    if(state.inventory.tools.fertilizer > 0) {
                        p.isFertilized = true; state.inventory.tools.fertilizer--;
                        showFloat(sx, sy, "üí© ƒê√£ b√≥n", "#22c55e");
                        updateUI();
                    } else showFloat(sx, sy, "H·∫øt ph√¢n b√≥n!", "#ef4444");
                }
                break;
            case 'seed':
                if(p.status === 'empty') {
                    if(state.inventory.seeds[state.selectedSeed] > 0) {
                        p.seedKey = state.selectedSeed;
                        p.status = 'growing';
                        p.progress = 0;
                        p.startTime = Date.now();
                        state.inventory.seeds[state.selectedSeed]--;
                        showFloat(sx, sy, "üå± Gieo h·∫°t", "#10b981");
                        updateUI();
                    } else showFloat(sx, sy, "H·∫øt h·∫°t gi·ªëng!", "#ef4444");
                }
                break;
            case 'hoe':
                if(p.status === 'empty' && p.tier === 1 && state.gold >= LAND_TIERS[2].cost) {
                    state.gold -= LAND_TIERS[2].cost;
                    p.tier = 2;
                    showFloat(sx, sy, "‚≠ê N√¢ng c·∫•p!", "#f59e0b");
                    updateUI();
                }
                break;
        }
    }

    function harvest(i, j, sx, sy) {
        const p = state.plots[i][j];
        const crop = CROPS[p.seedKey];
        state.inventory.crops[p.seedKey] += crop.yield;
        state.gold += crop.yield * 10; 
        addExp(crop.exp, sx, sy);
        p.status = 'empty'; p.seedKey = null; p.isWatered = false; p.isFertilized = false; p.progress = 0;
        showFloat(sx, sy-20, `+${crop.yield} ${crop.emoji}`, "#f59e0b");
        showFloat(sx, sy, `+${crop.yield * 10} üí∞`, "#facc15");
        updateUI();
    }

    function addExp(amount, sx, sy) {
        state.exp += amount;
        let maxExp = state.level * 100;
        if(state.exp >= maxExp) {
            state.exp -= maxExp;
            state.level++;
            showFloat(sx, sy-40, `üéâ L√™n C·∫•p ${state.level}!`, "#3b82f6");
            state.gold += 500;
        }
    }

    // --- GAME LOOP & RENDER CH√çNH X√ÅC ---
    function gameLoop() {
        const now = Date.now();
        state.plots.forEach(row => row.forEach(p => {
            if(p.status === 'growing') {
                const crop = CROPS[p.seedKey];
                const dt = (now - p.lastTick) / 1000;
                let multi = LAND_TIERS[p.tier].speed;
                if(p.isWatered) multi *= 1.5;
                if(p.isFertilized) multi *= 2.0;
                p.progress += (100 / crop.time) * multi * dt;
                if(p.progress >= 100) { p.progress = 100; p.status = 'ready'; }
            }
            p.lastTick = now;
        }));
        draw();
        gameLoopId = requestAnimationFrame(gameLoop);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        for (let i = 0; i < gridSize; i++) {
            for (let j = 0; j < gridSize; j++) {
                const p = state.plots[i][j];
                const pos = gridToScreen(i, j);

                // T·ªça ƒë·ªô v·∫Ω ·∫£nh (V√¨ SVG Box l√† 100x100, ta v·∫Ω ra h√¨nh vu√¥ng tileW x tileW)
                // ƒê·ªânh c·ªßa vi√™n kim c∆∞∆°ng ·ªü y = 25% chi·ªÅu cao ·∫£nh, n√™n ta ph·∫£i offset Y ƒë·ªÉ kh·ªõp v·ªõi pos.y
                const imgX = pos.x - tileW/2;
                const imgY = pos.y - (tileW * 0.25);

                // 1. V·∫º ƒê·∫§T (TILES)
                const tInfo = LAND_TIERS[p.tier];
                ctx.drawImage(tInfo.img, imgX, imgY, tileW, tileW);

                // 2. HIGHLIGHT KHI HOVER
                if(i === hoveredTile.i && j === hoveredTile.j) {
                    ctx.drawImage(ASSETS.highlight, imgX, imgY, tileW, tileW);
                }

                // 3. HI·ªÜU ·ª®NG T∆Ø·ªöI/B√ìN
                if(p.tier > 0 && (p.isFertilized || p.isWatered)) {
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y); 
                    ctx.lineTo(pos.x + tileW/2, pos.y + tileH/2);
                    ctx.lineTo(pos.x, pos.y + tileH); 
                    ctx.lineTo(pos.x - tileW/2, pos.y + tileH/2);
                    ctx.closePath();
                    
                    if(p.isFertilized) { ctx.fillStyle = 'rgba(234, 179, 8, 0.2)'; ctx.fill(); }
                    if(p.isWatered) { ctx.fillStyle = 'rgba(59, 130, 246, 0.2)'; ctx.fill(); }
                    ctx.restore();
                }

                // 4. ICON ·ªî KH√ìA
                if(p.tier === 0) {
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.beginPath(); ctx.arc(pos.x, pos.y + tileH/2, 14, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = '14px Arial'; ctx.textAlign = 'center'; 
                    ctx.fillText('üîí', pos.x, pos.y + tileH/2 + 5);
                    ctx.font = 'bold 12px Lexend';
                    ctx.fillText(tInfo.cost + ' üí∞', pos.x, pos.y + tileH/2 + 25);
                } 
                // 5. V·∫º C√ÇY & TI·∫æN TR√åNH
                else if(p.seedKey) {
                    const crop = CROPS[p.seedKey];
                    let imgToDraw = crop.imgStages[0];
                    if(p.status === 'ready') imgToDraw = crop.imgStages[2];
                    else if(p.progress > 50) imgToDraw = crop.imgStages[1];

                    // V·∫Ω c√¢y n·∫±m g·ªçn l√™n tr√™n m·∫∑t ƒë·∫•t
                    let cY = imgY - 10; 
                    if(p.status === 'ready') cY += Math.sin(Date.now()/200) * 3; // N·∫£y n·∫£y
                    ctx.drawImage(imgToDraw, imgX, cY, tileW, tileW);

                    // Thanh ti·∫øn tr√¨nh
                    if(p.status === 'growing') {
                        const barW = 40;
                        const barY = pos.y - 10;
                        ctx.fillStyle = 'rgba(0,0,0,0.6)'; ctx.fillRect(pos.x - barW/2, barY, barW, 5);
                        ctx.fillStyle = '#10b981'; ctx.fillRect(pos.x - barW/2, barY, barW * (p.progress/100), 5);
                        
                        if(p.isWatered) { ctx.font = '10px Arial'; ctx.fillText('üíß', pos.x - 25, barY + 5); }
                        if(p.isFertilized) { ctx.font = '10px Arial'; ctx.fillText('üí©', pos.x + 25, barY + 5); }
                    }
                }
            }
        }
    }

    // T·ªça ƒë·ªô chu·∫©n x√°c 100%
    function gridToScreen(i, j) { 
        return { 
            x: camera.x + (i - j) * (tileW/2), 
            y: camera.y + (i + j) * (tileH/2) 
        }; 
    }
    
    function screenToGrid(sx, sy) {
        const dx = sx - camera.x;
        const dy = sy - camera.y;
        const i = (dy / (tileH/2) + dx / (tileW/2)) / 2;
        const j = (dy / (tileH/2) - dx / (tileW/2)) / 2;
        return { i: Math.floor(i), j: Math.floor(j) };
    }

    // ================= UI C·∫¨P NH·∫¨T =================
    function updateUI() {
        document.getElementById('gold-val').innerText = state.gold.toLocaleString();
        document.getElementById('lvl-val').innerText = state.level;
        let maxExp = state.level * 100;
        document.getElementById('exp-val').innerText = `${Math.floor(state.exp)}/${maxExp}`;
        document.getElementById('exp-bar').style.width = `${(state.exp / maxExp) * 100}%`;

        document.getElementById('b-water').innerText = state.inventory.tools.water;
        document.getElementById('b-fert').innerText = state.inventory.tools.fertilizer;
        document.getElementById('b-seed').innerText = state.inventory.seeds[state.selectedSeed] || 0;
    }

    function showFloat(x, y, txt, color) {
        const div = document.createElement('div');
        div.className = 'float-info'; div.innerText = txt;
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.color = color;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

</script>

</body>
</html>


