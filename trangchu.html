<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√¥ng Tr·∫°i VIP Pro - ƒê·∫ßu T∆∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Lexend', sans-serif;
            background: #f3f4f6; /* N·ªÅn s√°ng s·ªßa s·∫°ch s·∫Ω cho app ƒë·∫ßu t∆∞ */
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }

        /* N·ªÅn cong m√†u xanh ·ªü tr√™n c√πng */
        .bg-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 220px;
            background: linear-gradient(135deg, #16a34a, #14532d);
            border-radius: 0 0 40px 40px; z-index: 0;
            box-shadow: 0 10px 30px rgba(22, 163, 74, 0.2);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        /* Khung cu·ªôn m∆∞·ª£t m√† */
        .scroll-area {
            position: absolute; top: 180px; bottom: 85px; left: 0; width: 100%;
            overflow-y: auto; padding: 0 16px; z-index: 10;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Hi·ªáu ·ª©ng th·∫ª ƒë·∫ßu t∆∞ */
        .invest-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .invest-card:active { transform: scale(0.98); }

        /* Progress Bar */
        .progress-bg { width: 100%; background: #e5e7eb; border-radius: 999px; height: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 1s linear; }
        
        .ready-pulse { animation: pulseReady 1.5s infinite; }
        @keyframes pulseReady {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        /* Floating Text */
        .float-info { 
            position: absolute; pointer-events: none; font-weight: 900; 
            font-size: 18px; text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
            animation: floatUp 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; z-index: 200; 
        }
        @keyframes floatUp { 
            0% { opacity: 0; transform: translateY(0) scale(0.8); } 
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-80px) scale(1); } 
        }

        /* Nav Bar C·ªë ƒê·ªãnh */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between;
            align-items: center; z-index: 150;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            border-radius: 24px 24px 0 0;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: #9ca3af; transition: all 0.2s; padding-top: 5px;
        }
        .nav-item:active { transform: scale(0.9); }
        
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn {
            position: absolute; top: -30px; width: 65px; height: 65px;
            background: linear-gradient(135deg, #22c55e, #15803d);
            border: 5px solid #f3f4f6; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(22, 163, 74, 0.3); transition: transform 0.2s;
        }
        .nav-center-btn:active { transform: scale(0.9); }

        /* Loader */
        #loading-screen {
            position: fixed; inset: 0; background: #14532d; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <div class="text-6xl animate-bounce mb-4">üöú</div>
    <h2 class="text-2xl font-black mb-2 tracking-widest text-green-300">ƒêANG T·∫¢I...</h2>
    <p id="loading-text" class="text-sm font-semibold text-green-100 opacity-70">Kh·ªüi t·∫°o d·ªØ li·ªáu ƒë·∫ßu t∆∞</p>
</div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-1000">
    
    <!-- Background Header -->
    <div class="bg-header"></div>

    <!-- TOP BAR (User Info) -->
    <div class="absolute top-6 left-0 w-full px-5 flex justify-between items-start z-50">
        <div class="flex flex-col gap-3">
            <div>
                <p class="text-green-100 text-xs font-bold uppercase tracking-wider mb-0.5">Xin ch√†o n√¥ng d√¢n,</p>
                <h1 id="player-name" class="text-white text-xl font-black shadow-sm">Kh√°ch</h1>
            </div>
            <a href="tk.html" class="glass-panel px-4 py-2.5 rounded-2xl flex items-center gap-2 active:scale-95 transition-transform w-fit no-underline">
                <span class="text-2xl drop-shadow-md">üí∞</span>
                <span id="gold-val" class="font-black text-orange-600 text-xl tracking-tight">---</span>
            </a>
        </div>
        
        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-4 py-1.5 rounded-full flex flex-col items-end min-w-[100px]">
                <span class="text-[10px] font-bold text-stone-500 uppercase">C·∫•p ƒë·ªô <span id="lvl-val" class="text-blue-600 font-black">1</span></span>
                <div class="w-full h-1.5 bg-stone-200 rounded-full mt-1 overflow-hidden">
                    <div id="exp-bar" class="h-full bg-blue-500" style="width: 0%;"></div>
                </div>
            </div>
            <button id="save-btn" class="glass-panel w-11 h-11 rounded-full flex items-center justify-center active:scale-95 transition-transform text-xl shadow-md">
                üíæ
            </button>
        </div>
    </div>

    <!-- TABS M√ÄN H√åNH -->
    <div class="absolute top-[130px] left-0 w-full px-5 z-20 flex gap-2">
        <button id="tab-market" class="flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-green-700 shadow-md">Th·ªã Tr∆∞·ªùng</button>
        <button id="tab-myfarms" class="flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm">Trang Tr·∫°i C·ªßa T√¥i</button>
    </div>

    <!-- V√ôNG CU·ªòN (Ch·ª©a c√°c g√≥i ƒë·∫ßu t∆∞) -->
    <div class="scroll-area no-scrollbar" id="main-content">
        <!-- Render n·ªôi dung v√†o ƒë√¢y b·∫±ng JS -->
    </div>

    <!-- UI: NAVIGATION BAR -->
    <div class="nav-bar">
        <a href="shop.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üõçÔ∏è</span>
            <span class="text-[9px] font-black uppercase tracking-wide">C·ª≠a h√†ng</span>
        </a>
        <a href="kho.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üì¶</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Kho</span>
        </a>
        
        <a href="trangchu.html" class="nav-center-wrap text-green-700">
            <div class="nav-center-btn">
                <span class="text-3xl pb-1">üå±</span>
            </div>
            <span class="text-[10px] font-black uppercase mt-12 tracking-wider">ƒê·∫ßu t∆∞</span>
        </a>
        
        <a href="gt.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üéÆ</span>
            <span class="text-[9px] font-black uppercase tracking-wide">Gi·∫£i tr√≠</span>
        </a>
        <a href="tk.html" class="nav-item">
            <span class="text-2xl mb-1 grayscale opacity-70">üë§</span>
            <span class="text-[9px] font-black uppercase tracking-wide">T√†i kho·∫£n</span>
        </a>
    </div>
</div>

<script type="module">
    // ================= FIREBASE CONFIG =================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45",
      measurementId: "G-RT8HPTJERF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ================= D·ªÆ LI·ªÜU C√ÅC G√ìI ƒê·∫¶U T∆Ø =================
    const PACKAGES = {
        carrot: { 
            id: 'carrot', name: 'Trang tr·∫°i C√† r·ªët', icon: 'ü•ï', 
            cost: 500, time: 60, yield: 700, exp: 20, 
            bg: 'from-orange-100 to-orange-50', text: 'text-orange-600',
            desc: 'Thu ho·∫°ch nhanh, ph√π h·ª£p cho ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu.'
        },
        potato: { 
            id: 'potato', name: 'Trang tr·∫°i Khoai t√¢y', icon: 'ü•î', 
            cost: 2000, time: 300, yield: 3000, exp: 50, 
            bg: 'from-yellow-100 to-amber-50', text: 'text-yellow-700',
            desc: 'L·ª£i nhu·∫≠n ·ªïn ƒë·ªãnh, r·ªßi ro th·∫•p.'
        },
        pumpkin: { 
            id: 'pumpkin', name: 'Trang tr·∫°i B√≠ ng√¥', icon: 'üéÉ', 
            cost: 10000, time: 1800, yield: 16000, exp: 150, 
            bg: 'from-orange-200 to-orange-100', text: 'text-orange-800',
            desc: 'C·∫ßn th·ªùi gian l√¢u nh∆∞ng mang l·∫°i doanh thu l·ªõn.'
        },
        watermelon: { 
            id: 'watermelon', name: 'Trang tr·∫°i D∆∞a h·∫•u', icon: 'üçâ', 
            cost: 50000, time: 7200, yield: 85000, exp: 500, 
            bg: 'from-green-200 to-green-100', text: 'text-green-800',
            desc: 'G√≥i VIP. L·ª£i nhu·∫≠n kh·ªïng l·ªì, th√≠ch h·ª£p ƒë·∫ßu t∆∞ d√†i h·∫°n.'
        }
    };

    // ================= TR·∫†NG TH√ÅI GAME =================
    let state = {
        gold: 1000,
        level: 1,
        exp: 0,
        investments: [] // M·∫£ng ch·ª©a c√°c g√≥i ƒëang ƒë·∫ßu t∆∞: { id, pkgId, startTime, harvested }
    };

    let currentUser = null;
    let currentTab = 'market'; // 'market' ho·∫∑c 'myfarms'
    let timerInterval;

    const DOM = {
        loading: document.getElementById('loading-screen'),
        container: document.getElementById('game-container'),
        content: document.getElementById('main-content'),
        goldVal: document.getElementById('gold-val'),
        lvlVal: document.getElementById('lvl-val'),
        expBar: document.getElementById('exp-bar'),
        tabMarket: document.getElementById('tab-market'),
        tabMyFarms: document.getElementById('tab-myfarms')
    };

    // ================= FIREBASE LOGIC =================
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('player-name').innerText = user.displayName || 'Nh√† ƒê·∫ßu T∆∞';
            await loadGameFromCloud();
            startGame();
        } else {
            window.location.href = 'index.html';
        }
    });

    async function loadGameFromCloud() {
        try {
            const docRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                state.gold = data.gold ?? 1000;
                state.level = data.level || 1;
                state.exp = data.exp || 0;
                // Ch·ªâ l·∫•y nh·ªØng kho·∫£n ƒë·∫ßu t∆∞ ch∆∞a thu ho·∫°ch
                state.investments = (data.investments || []).filter(inv => !inv.harvested);
            } else {
                await saveGameToCloud(false); 
            }
        } catch (e) {
            console.error("L·ªói t·∫£i d·ªØ li·ªáu Cloud:", e);
        }
    }

    async function saveGameToCloud(showNotif = false) {
        if(!currentUser) return;
        try {
            await setDoc(doc(db, "users", currentUser.uid), {
                gold: state.gold, level: state.level, exp: state.exp,
                investments: state.investments, lastSaved: new Date()
            }, { merge: true });
            if(showNotif) showFloat(window.innerWidth/2, 100, "ƒê√£ l∆∞u ‚òÅÔ∏è", "#22c55e");
        } catch(e) {
            console.error("L·ªói l∆∞u Cloud:", e);
        }
    }

    document.getElementById('save-btn').addEventListener('click', () => saveGameToCloud(true));

    // ================= KH·ªûI ƒê·ªòNG GAME =================
    function startGame() {
        updateUI();
        renderContent();
        
        DOM.loading.style.opacity = '0';
        setTimeout(() => {
            DOM.loading.style.display = 'none';
            DOM.container.style.opacity = '1';
        }, 500);

        // V√≤ng l·∫∑p c·∫≠p nh·∫≠t th·ªùi gian ti·∫øn tr√¨nh m·ªói gi√¢y
        timerInterval = setInterval(updateProgressBars, 1000);
        setInterval(() => saveGameToCloud(false), 30000); // Auto save
    }

    // ================= RENDER GIAO DI·ªÜN CH√çNH =================
    DOM.tabMarket.addEventListener('click', () => switchTab('market'));
    DOM.tabMyFarms.addEventListener('click', () => switchTab('myfarms'));

    function switchTab(tab) {
        currentTab = tab;
        if(tab === 'market') {
            DOM.tabMarket.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-green-700 shadow-md";
            DOM.tabMyFarms.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm";
        } else {
            DOM.tabMyFarms.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white text-green-700 shadow-md";
            DOM.tabMarket.className = "flex-1 py-3 rounded-2xl font-bold transition-colors bg-white/20 text-white hover:bg-white/30 backdrop-blur-sm";
        }
        renderContent();
    }

    function renderContent() {
        DOM.content.innerHTML = '';
        if(currentTab === 'market') {
            renderMarket();
        } else {
            renderMyFarms();
        }
    }

    // --- TAB 1: TH·ªä TR∆Ø·ªúNG (MUA G√ìI) ---
    function renderMarket() {
        const wrapper = document.createElement('div');
        wrapper.className = "space-y-4 pb-10";

        Object.values(PACKAGES).forEach(pkg => {
            const canAfford = state.gold >= pkg.cost;
            const card = document.createElement('div');
            card.className = `invest-card bg-gradient-to-br ${pkg.bg} p-4 rounded-3xl border border-white shadow-sm flex flex-col`;
            
            card.innerHTML = `
                <div class="flex gap-4 items-center mb-3">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-4xl shadow-sm shrink-0">
                        ${pkg.icon}
                    </div>
                    <div>
                        <h3 class="font-black text-[17px] text-stone-800 leading-tight mb-1">${pkg.name}</h3>
                        <p class="text-[11px] text-stone-500 leading-snug">${pkg.desc}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-white/60 p-2 rounded-xl text-center">
                        <p class="text-[10px] text-stone-500 font-bold uppercase">Th·ªùi gian</p>
                        <p class="font-black ${pkg.text}">${formatTime(pkg.time)}</p>
                    </div>
                    <div class="bg-white/60 p-2 rounded-xl text-center">
                        <p class="text-[10px] text-stone-500 font-bold uppercase">Thu v·ªÅ</p>
                        <p class="font-black text-green-600">${pkg.yield.toLocaleString()} üí∞</p>
                    </div>
                </div>
                <button class="w-full py-3.5 rounded-xl font-black text-white shadow-md transition-colors ${canAfford ? 'bg-green-600 hover:bg-green-700' : 'bg-stone-300'}" 
                        ${canAfford ? '' : 'disabled'}
                        onclick="invest('${pkg.id}', event)">
                    ${canAfford ? `ƒê·∫¶U T∆Ø (${pkg.cost.toLocaleString()} üí∞)` : 'CH∆ØA ƒê·ª¶ V√ÄNG'}
                </button>
            `;
            wrapper.appendChild(card);
        });
        DOM.content.appendChild(wrapper);
    }

    // --- TAB 2: TRANG TR·∫†I C·ª¶A T√îI ---
    function renderMyFarms() {
        const wrapper = document.createElement('div');
        wrapper.className = "space-y-4 pb-10";

        if(state.investments.length === 0) {
            wrapper.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 opacity-50">
                    <span class="text-6xl mb-4 grayscale">üöú</span>
                    <p class="font-bold text-stone-600">B·∫°n ch∆∞a c√≥ trang tr·∫°i n√†o.</p>
                    <p class="text-xs text-stone-500">H√£y sang Th·ªã Tr∆∞·ªùng ƒë·ªÉ ƒë·∫ßu t∆∞ nh√©!</p>
                </div>
            `;
            DOM.content.appendChild(wrapper);
            return;
        }

        // ƒê·∫£o ng∆∞·ª£c m·∫£ng ƒë·ªÉ c√°i m·ªõi mua n·∫±m tr√™n c√πng
        [...state.investments].reverse().forEach(inv => {
            const pkg = PACKAGES[inv.pkgId];
            if(!pkg) return; // Ph√≤ng l·ªói data

            const card = document.createElement('div');
            card.className = `glass-panel p-4 rounded-3xl relative overflow-hidden invest-card`;
            card.id = `inv-card-${inv.id}`;
            
            // V·∫Ω ban ƒë·∫ßu, thanh ti·∫øn tr√¨nh s·∫Ω ƒë∆∞·ª£c h√†m updateProgressBars c·∫≠p nh·∫≠t ngay sau ƒë√≥
            card.innerHTML = `
                <div class="flex gap-4 items-center mb-4">
                    <div class="w-14 h-14 bg-gradient-to-br ${pkg.bg} rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white shrink-0">
                        ${pkg.icon}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 class="font-black text-[15px] text-stone-800">${pkg.name}</h3>
                            <span class="font-black text-green-600">+${pkg.yield.toLocaleString()} üí∞</span>
                        </div>
                        <p class="text-[11px] text-stone-500 font-bold mb-1 status-text" id="status-${inv.id}">ƒêang sinh tr∆∞·ªüng...</p>
                        
                        <div class="progress-bg">
                            <div class="progress-fill bg-blue-500" id="prog-${inv.id}" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <button class="w-full py-3 rounded-xl font-black text-white bg-blue-500 opacity-50 cursor-not-allowed transition-all harvest-btn" 
                        id="btn-${inv.id}" disabled>
                    ƒêANG TR·ªíNG (<span id="time-${inv.id}">--:--</span>)
                </button>
            `;
            wrapper.appendChild(card);
        });

        DOM.content.appendChild(wrapper);
        updateProgressBars(); // C·∫≠p nh·∫≠t ngay ti·∫øn tr√¨nh sau khi render
    }

    // ================= LOGIC ƒê·∫¶U T∆Ø & THU HO·∫†CH =================
    window.invest = function(pkgId, e) {
        const pkg = PACKAGES[pkgId];
        if(state.gold >= pkg.cost) {
            state.gold -= pkg.cost;
            const newInv = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                pkgId: pkgId,
                startTime: Date.now(),
                harvested: false
            };
            state.investments.push(newInv);
            
            updateUI();
            saveGameToCloud();
            
            // L·∫•y t·ªça ƒë·ªô click ƒë·ªÉ hi·ªán ch·ªØ n·ªïi
            const rect = e.target.getBoundingClientRect();
            showFloat(rect.left + rect.width/2, rect.top, `-${pkg.cost} üí∞`, "#ef4444");
            
            // T·ª± ƒë·ªông chuy·ªÉn sang tab Trang tr·∫°i c·ªßa t√¥i
            setTimeout(() => switchTab('myfarms'), 300);
        }
    };

    window.harvest = function(invId, e) {
        const invIndex = state.investments.findIndex(i => i.id === invId);
        if(invIndex === -1) return;
        
        const inv = state.investments[invIndex];
        const pkg = PACKAGES[inv.pkgId];

        // C·ªông ti·ªÅn v√† kinh nghi·ªám
        state.gold += pkg.yield;
        addExp(pkg.exp);
        
        // ƒê√°nh d·∫•u ƒë√£ thu ho·∫°ch v√† x√≥a kh·ªèi m·∫£ng
        state.investments.splice(invIndex, 1);
        
        updateUI();
        saveGameToCloud();
        
        const rect = e.target.getBoundingClientRect();
        showFloat(rect.left + rect.width/2, rect.top, `+${pkg.yield.toLocaleString()} üí∞`, "#f59e0b");
        
        // X√≥a th·∫ª kh·ªèi UI m∆∞·ª£t m√†
        const card = document.getElementById(`inv-card-${invId}`);
        if(card) {
            card.style.transform = "scale(0.8)";
            card.style.opacity = "0";
            setTimeout(() => { card.remove(); if(state.investments.length === 0) renderMyFarms(); }, 300);
        }
    };

    function addExp(amount) {
        state.exp += amount;
        let maxExp = state.level * 100;
        if(state.exp >= maxExp) {
            state.exp -= maxExp;
            state.level++;
            state.gold += 1000; // Th∆∞·ªüng thƒÉng c·∫•p
            showFloat(window.innerWidth/2, 150, `üéâ L√™n C·∫•p ${state.level}!`, "#3b82f6");
        }
    }

    // ================= LOOP C·∫¨P NH·∫¨T TH·ªúI GIAN =================
    function updateProgressBars() {
        if(currentTab !== 'myfarms') return;

        const now = Date.now();
        state.investments.forEach(inv => {
            const pkg = PACKAGES[inv.pkgId];
            if(!pkg) return;

            const elapsedSec = (now - inv.startTime) / 1000;
            let percent = (elapsedSec / pkg.time) * 100;
            
            const bar = document.getElementById(`prog-${inv.id}`);
            const btn = document.getElementById(`btn-${inv.id}`);
            const timeTxt = document.getElementById(`time-${inv.id}`);
            const statusTxt = document.getElementById(`status-${inv.id}`);

            if(!bar || !btn) return;

            if (percent >= 100) {
                percent = 100;
                bar.style.width = '100%';
                bar.className = "progress-fill bg-green-500";
                
                statusTxt.innerText = "S·∫µn s√†ng thu ho·∫°ch!";
                statusTxt.className = "text-[11px] font-black mb-1 text-green-600";
                
                // ƒê·ªïi n√∫t th√†nh n√∫t Thu Ho·∫°ch
                if(btn.disabled) {
                    btn.disabled = false;
                    btn.className = "w-full py-3 rounded-xl font-black text-white bg-green-500 hover:bg-green-600 shadow-lg shadow-green-200 ready-pulse active:scale-95 transition-all";
                    btn.innerHTML = `THU HO·∫†CH NGAY`;
                    btn.onclick = (e) => harvest(inv.id, e);
                }
            } else {
                bar.style.width = `${percent}%`;
                const remSec = Math.ceil(pkg.time - elapsedSec);
                timeTxt.innerText = formatTime(remSec);
            }
        });
    }

    // ================= C√îNG C·ª§ H·ªñ TR·ª¢ =================
    function updateUI() {
        DOM.goldVal.innerText = state.gold.toLocaleString();
        DOM.lvlVal.innerText = state.level;
        let maxExp = state.level * 100;
        DOM.expBar.style.width = `${(state.exp / maxExp) * 100}%`;
        
        // N·∫øu ƒëang ·ªü tab Market, c·∫≠p nh·∫≠t l·∫°i ƒë·ªÉ n√∫t Mua disable/enable t√πy l∆∞·ª£ng v√†ng
        if(currentTab === 'market') renderMarket();
    }

    function formatTime(seconds) {
        if(seconds < 60) return `${seconds} gi√¢y`;
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        if(m < 60) return `${m}p ${s}s`;
        const h = Math.floor(m / 60);
        const rm = m % 60;
        return `${h}h ${rm}p`;
    }

    function showFloat(x, y, txt, color) {
        const div = document.createElement('div');
        div.className = 'float-info'; div.innerText = txt;
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.color = color;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1200);
    }

</script>

</body>
</html>


