<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N√¥ng Tr·∫°i Heo Con - ƒê·∫ßu T∆∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800;900&display=swap');
        
        body {
            margin: 0; padding: 0; overflow: hidden;
            font-family: 'Lexend', sans-serif;
            background: #f0f2f5; 
            user-select: none; -webkit-user-select: none; touch-action: manipulation;
        }

        .bg-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 240px;
            background: linear-gradient(135deg, #0f766e, #064e3b);
            border-radius: 0 0 45px 45px; z-index: 0;
            box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.05);
        }

        .scroll-area {
            position: absolute; top: 195px; bottom: 85px; left: 0; width: 100%;
            overflow-y: auto; padding: 0 16px; z-index: 10;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Progress Animation */
        .progress-bg { width: 100%; background: #e5e7eb; border-radius: 999px; height: 12px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 999px; transition: width 1s linear; }

        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: white; display: flex; justify-content: space-between;
            align-items: center; z-index: 150;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            border-radius: 24px 24px 0 0;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: #9ca3af; transition: all 0.2s; padding-top: 5px;
        }
        
        .nav-center-wrap { position: relative; flex: 1.2; display: flex; justify-content: center; }
        .nav-center-btn {
            position: absolute; top: -30px; width: 65px; height: 65px;
            background: linear-gradient(135deg, #10b981, #047857);
            border: 5px solid #f0f2f5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        #loading-screen {
            position: fixed; inset: 0; background: #064e3b; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: opacity 0.4s ease;
        }

        .float-info { 
            position: absolute; pointer-events: none; font-weight: 900; 
            font-size: 18px; text-shadow: 1px 1px 0 #fff;
            animation: floatUp 1s forwards; z-index: 200; 
        }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-70px); } }
    </style>
</head>
<body>

<!-- M√†n h√¨nh load c√≥ th·ªùi gian ch·ªù t·ªëi ƒëa -->
<div id="loading-screen">
    <div class="text-6xl animate-bounce mb-4">üöÄ</div>
    <h2 class="text-xl font-black tracking-widest text-emerald-300 uppercase">ƒêang ƒë·ªìng b·ªô...</h2>
    <p class="text-xs text-emerald-100/50 mt-2">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
</div>

<div id="game-container" class="relative w-screen h-screen opacity-0 transition-opacity duration-500">
    <div class="bg-header"></div>

    <!-- TOP UI -->
    <div class="absolute top-5 left-0 w-full px-5 flex justify-between items-start z-50">
        <div class="flex flex-col gap-2">
            <div>
                <h1 id="player-name" class="text-white text-base font-black leading-tight truncate max-w-[150px]">N√¥ng D√¢n</h1>
                <p class="text-emerald-200 text-[10px] font-bold uppercase tracking-wide">C·∫•p ƒë·ªô <span id="lvl-val">1</span></p>
            </div>
            <div class="glass-panel px-3 py-1.5 rounded-xl flex items-center gap-1.5 border-white/20 shadow-lg">
                <span class="text-lg">üí∞</span>
                <span id="gold-val" class="font-black text-orange-600 text-lg tracking-tight">---</span>
            </div>
        </div>
        
        <div class="flex flex-col items-end gap-2">
            <div class="glass-panel px-3 py-1.5 rounded-xl text-right border-white/20">
                <span class="text-[9px] font-bold text-stone-500 uppercase leading-none">D·ª± √°n</span>
                <div class="font-black text-emerald-700 text-sm">
                    <span id="slot-used">0</span> / <span id="slot-max">2</span>
                </div>
            </div>
            <button id="save-btn" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center shadow-md active:scale-90 transition-transform">
                üíæ
            </button>
        </div>
    </div>

    <!-- TABS -->
    <div class="absolute top-[145px] left-0 w-full px-5 z-20 flex gap-2">
        <button id="tab-market" class="flex-1 py-3 rounded-2xl font-black transition-all bg-white text-emerald-700 shadow-md">D·ª∞ √ÅN M·ªöI</button>
        <button id="tab-myfarms" class="flex-1 py-3 rounded-2xl font-bold transition-all bg-white/20 text-white backdrop-blur-sm">C·ª¶A T√îI</button>
    </div>

    <!-- CONTENT -->
    <div class="scroll-area no-scrollbar" id="main-content"></div>

    <!-- FOOTER NAV -->
    <div class="nav-bar">
        <a href="shop.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üõçÔ∏è</span><span class="text-[9px] font-black uppercase tracking-wide">C·ª≠a h√†ng</span></a>
        <a href="kho.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üì¶</span><span class="text-[9px] font-black uppercase tracking-wide">Kho</span></a>
        <a href="trangchu.html" class="nav-center-wrap text-emerald-700">
            <div class="nav-center-btn"><span class="text-3xl pb-1">üå±</span></div>
            <span class="text-[10px] font-black uppercase mt-12 tracking-wider">ƒê·∫ßu t∆∞</span>
        </a>
        <a href="gt.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üéÆ</span><span class="text-[9px] font-black uppercase tracking-wide">Gi·∫£i tr√≠</span></a>
        <a href="tk.html" class="nav-item"><span class="text-2xl mb-1 grayscale opacity-60">üë§</span><span class="text-[9px] font-black uppercase tracking-wide">T√†i kho·∫£n</span></a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQa6awFxFTOrRXPnda8rS6vlKLKPDMJT0",
      authDomain: "nongtraiheocon.firebaseapp.com",
      projectId: "nongtraiheocon",
      storageBucket: "nongtraiheocon.firebasestorage.app",
      messagingSenderId: "964519162656",
      appId: "1:964519162656:web:27247ed6287dfc74ef5d45"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "nongtraiheocon";

    // --- DATA ---
    const PACKAGES = {
        carrot: { id: 'carrot', name: 'D·ª± √°n C√† r·ªët', icon: 'ü•ï', cost: 500, time: 60, exp: 20, yieldName: 'Th√πng C√† r·ªët', yieldQty: 2, bg: 'from-orange-100' },
        cow: { id: 'cow', name: 'D·ª± √°n B√≤ s·ªØa', icon: 'üêÑ', cost: 2000, time: 300, exp: 50, yieldName: 'Th√πng S·ªØa', yieldQty: 1, bg: 'from-sky-100' },
        chicken: { id: 'chicken', name: 'D·ª± √°n G√† tr·ª©ng', icon: 'üêî', cost: 5000, time: 900, exp: 120, yieldName: 'V·ªâ Tr·ª©ng', yieldQty: 3, bg: 'from-yellow-100' },
        sheep: { id: 'sheep', name: 'D·ª± √°n C·ª´u b√¥ng', icon: 'üêë', cost: 15000, time: 1800, exp: 300, yieldName: 'Kg B√¥ng', yieldQty: 2, bg: 'from-slate-200' }
    };

    let state = { 
        gold: 10000, 
        level: 1, 
        exp: 0, 
        maxProjects: 2, 
        investments: [], 
        inventory: { carrot: 0, cow: 0, chicken: 0, sheep: 0 } 
    };

    let currentUser = null;
    let currentTab = 'market';

    // Auth & Data Loading
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('player-name').innerText = user.displayName || "N√¥ng d√¢n m·ªõi";
            
            // Timeout 3s cho vi·ªác t·∫£i d·ªØ li·ªáu t·ª´ Cloud
            const loadPromise = loadData();
            const timeoutPromise = new Promise(res => setTimeout(res, 3000));
            
            await Promise.race([loadPromise, timeoutPromise]);
            enterGame();
        } else {
            // N·∫øu m·∫•t Auth, th·ª≠ login l·∫°i ho·∫∑c v·ªÅ index
            window.location.href = 'index.html';
        }
    });

    async function loadData() {
        try {
            const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'global');
            const snap = await getDoc(userDocRef);
            if (snap.exists()) {
                const cloudData = snap.data();
                // Merge data c·∫©n th·∫≠n ƒë·ªÉ tr√°nh m·∫•t field m·ªõi
                state = { ...state, ...cloudData };
                // L·ªçc b·ªè d·ª± √°n ƒë√£ ƒë√°nh d·∫•u ho√†n th√†nh
                state.investments = (state.investments || []).filter(i => !i.harvested);
                return true;
            }
        } catch (e) {
            console.error("L·ªói ƒë·ªçc Firebase:", e);
        }
        return false;
    }

    async function saveData(silent = true) {
        if(!currentUser) return;
        try {
            const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'data', 'global');
            await setDoc(userDocRef, state, { merge: true });
            if(!silent) showFloat(window.innerWidth/2, 120, "ƒê√£ l∆∞u ‚òÅÔ∏è", "#10b981");
        } catch(e) { console.error("L·ªói ghi Firebase:", e); }
    }

    function enterGame() {
        updateUI();
        renderContent();
        
        const loader = document.getElementById('loading-screen');
        loader.style.opacity = '0';
        setTimeout(() => {
            loader.style.display = 'none';
            document.getElementById('game-container').style.opacity = '1';
        }, 400);

        setInterval(tick, 1000);
        setInterval(() => saveData(true), 30000); // Auto save m·ªói 30s
    }

    // --- UI & RENDER ---
    const switchTab = (tab) => {
        currentTab = tab;
        document.getElementById('tab-market').className = tab === 'market' ? "flex-1 py-3 rounded-2xl font-black bg-white text-emerald-700 shadow-md" : "flex-1 py-3 rounded-2xl font-bold bg-white/20 text-white backdrop-blur-sm";
        document.getElementById('tab-myfarms').className = tab === 'myfarms' ? "flex-1 py-3 rounded-2xl font-black bg-white text-emerald-700 shadow-md" : "flex-1 py-3 rounded-2xl font-bold bg-white/20 text-white backdrop-blur-sm";
        renderContent();
    };

    document.getElementById('tab-market').onclick = () => switchTab('market');
    document.getElementById('tab-myfarms').onclick = () => switchTab('myfarms');

    function renderContent() {
        const container = document.getElementById('main-content');
        container.innerHTML = '';

        if(currentTab === 'market') {
            const isFull = state.investments.length >= state.maxProjects;
            
            // Land expansion card
            if(isFull) {
                const cost = state.maxProjects * 5000;
                container.innerHTML += `
                <div class="bg-orange-50 p-4 rounded-3xl mb-4 border border-orange-200 text-center">
                    <p class="font-black text-orange-700 text-sm mb-2">H·∫æT CH·ªñ TR·ªêNG D·ª∞ √ÅN</p>
                    <button onclick="window.buySlot(${cost})" class="w-full py-3 bg-orange-500 text-white font-black rounded-xl shadow-lg active:scale-95 transition-all">M·ªû R·ªòNG √î ƒê·∫§T: ${cost} üí∞</button>
                </div>`;
            }

            Object.values(PACKAGES).forEach(pkg => {
                const canBuy = state.gold >= pkg.cost && !isFull;
                container.innerHTML += `
                <div class="glass-panel p-4 rounded-[2rem] mb-4 flex flex-col ${!canBuy ? 'opacity-60 grayscale-[0.5]' : ''}">
                    <div class="flex gap-4 mb-3 items-center">
                        <div class="w-14 h-14 bg-gradient-to-br ${pkg.bg} to-white rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-white">${pkg.icon}</div>
                        <div>
                            <h3 class="font-black text-stone-800 text-sm">${pkg.name}</h3>
                            <p class="text-[10px] font-bold text-stone-400 uppercase">S·∫£n l∆∞·ª£ng: ${pkg.yieldQty} ${pkg.yieldName}</p>
                        </div>
                    </div>
                    <button onclick="window.invest('${pkg.id}')" ${!canBuy ? 'disabled' : ''} class="w-full py-4 bg-emerald-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-all">
                        ${state.gold < pkg.cost ? 'KH√îNG ƒê·ª¶ V√ÄNG' : isFull ? 'ƒê√É H·∫æT SLOT' : `ƒê·∫¶U T∆Ø: ${pkg.cost.toLocaleString()} üí∞`}
                    </button>
                </div>`;
            });
        } else {
            if(state.investments.length === 0) {
                container.innerHTML = `<div class="py-20 text-center opacity-40"><p class="font-black text-stone-400 text-sm uppercase tracking-widest">B·∫°n ch∆∞a c√≥ d·ª± √°n n√†o</p></div>`;
                return;
            }
            [...state.investments].reverse().forEach(inv => {
                const p = PACKAGES[inv.pkgId];
                container.innerHTML += `
                <div class="glass-panel p-5 rounded-[2rem] mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">${p.icon}</span>
                            <h3 class="font-black text-stone-700 text-sm">${p.name}</h3>
                        </div>
                        <span id="time-${inv.id}" class="text-xs font-black text-emerald-600">--:--</span>
                    </div>
                    <div class="progress-bg mb-4">
                        <div id="prog-${inv.id}" class="progress-fill bg-emerald-500 shadow-sm" style="width:0%"></div>
                    </div>
                    <button id="btn-${inv.id}" disabled class="w-full py-3.5 bg-stone-100 text-stone-400 font-black rounded-2xl text-xs uppercase tracking-tighter">ƒêang th·ª±c hi·ªán...</button>
                </div>`;
            });
        }
    }

    // --- GAME LOGIC ---
    window.invest = (pkgId) => {
        const p = PACKAGES[pkgId];
        if(state.gold >= p.cost && state.investments.length < state.maxProjects) {
            state.gold -= p.cost;
            state.investments.push({
                id: 'inv_' + Date.now() + Math.floor(Math.random()*1000),
                pkgId: pkgId,
                startTime: Date.now(),
                harvested: false
            });
            updateUI();
            saveData(true);
            switchTab('myfarms');
        }
    };

    window.buySlot = (cost) => {
        if(state.gold >= cost) {
            state.gold -= cost;
            state.maxProjects++;
            updateUI();
            saveData(false);
            renderContent();
        }
    };

    function tick() {
        if(currentTab !== 'myfarms') return;
        const now = Date.now();
        state.investments.forEach(inv => {
            const pkg = PACKAGES[inv.pkgId];
            if(!pkg) return;
            const elapsed = (now - inv.startTime) / 1000;
            const pct = Math.min(100, (elapsed / pkg.time) * 100);
            
            const bar = document.getElementById(`prog-${inv.id}`);
            const btn = document.getElementById(`btn-${inv.id}`);
            const txt = document.getElementById(`time-${inv.id}`);

            if(bar) bar.style.width = pct + '%';
            if(txt) txt.innerText = pct >= 100 ? "Ho√†n t·∫•t!" : Math.ceil(pkg.time - elapsed) + " gi√¢y";
            
            if(pct >= 100 && btn && btn.disabled) {
                btn.disabled = false;
                btn.innerText = `THU HO·∫†CH ${pkg.yieldQty} ${pkg.yieldName.toUpperCase()}`;
                btn.className = "w-full py-3.5 bg-emerald-600 text-white font-black rounded-2xl shadow-lg shadow-emerald-100 active:scale-95 transition-all text-xs";
                btn.onclick = () => harvest(inv.id);
            }
        });
    }

    function harvest(invId) {
        const inv = state.investments.find(i => i.id === invId);
        if(!inv) return;
        const pkg = PACKAGES[inv.pkgId];

        state.inventory[inv.pkgId] = (state.inventory[inv.pkgId] || 0) + pkg.yieldQty;
        state.exp += pkg.exp;
        state.investments = state.investments.filter(i => i.id !== invId);

        // Level up
        if(state.exp >= state.level * 100) {
            state.exp -= state.level * 100;
            state.level++;
            state.gold += 1000;
            alert(`üéâ Ch√∫c m·ª´ng! B·∫°n l√™n c·∫•p ${state.level} v√† nh·∫≠n 1.000 V√†ng!`);
        }

        updateUI();
        saveData(true);
        renderContent();
        showFloat(window.innerWidth/2, 150, `+${pkg.yieldQty} ${pkg.yieldName}`, "#10b981");
    }

    function updateUI() {
        document.getElementById('gold-val').innerText = state.gold.toLocaleString();
        document.getElementById('lvl-val').innerText = state.level;
        document.getElementById('slot-used').innerText = state.investments.length;
        document.getElementById('slot-max').innerText = state.maxProjects;
    }

    document.getElementById('save-btn').onclick = () => saveData(false);

    function showFloat(x, y, t, c) {
        const d = document.createElement('div');
        d.className = 'float-info'; d.innerText = t;
        d.style.left = x + 'px'; d.style.top = y + 'px'; d.style.color = c;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 1000);
    }
</script>
</body>
</html>

